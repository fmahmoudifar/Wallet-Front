{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}

<!-- stocks data provided to JS via data attribute to avoid inline template tags in scripts -->
<div id="stocks-data" style="display:none" data-stocks='{{ stocks|tojson | safe }}'></div>
<input type="hidden" id="stockBaseCurrency" value="{{ base_currency|default('EUR') }}">

<script>
    function setStockNavVisibility(activeView) {
        const btns = Array.from(document.querySelectorAll('[data-stock-nav]'));
        btns.forEach(btn => {
            const v = String(btn.getAttribute('data-stock-nav') || '').trim();
            const isActive = (v && v === String(activeView || ''));
            if (isActive) btn.setAttribute('aria-current', 'page');
            else btn.removeAttribute('aria-current');
            btn.classList.toggle('is-active', isActive);
        });
    }

    function getStocksData() {
        try {
            const el = document.getElementById('stocks-data');
            if (!el || !el.dataset || !el.dataset.stocks) return [];
            const arr = JSON.parse(el.dataset.stocks);
            return Array.isArray(arr) ? arr : [];
        } catch (e) {
            return [];
        }
    }

    function formatNumber(value, maxDigits) {
        const v = Number(value);
        if (!isFinite(v)) return '0';
        const opts = { maximumFractionDigits: (typeof maxDigits === 'number' ? maxDigits : 6) };
        try {
            return new Intl.NumberFormat(undefined, opts).format(v);
        } catch (e) {
            return String(v);
        }
    }

    function buildStockPortfolio() {
        const container = document.getElementById('stockPortfolioCards');
        const emptyMsg = document.getElementById('stockPortfolioEmpty');
        if (!container) return;

        const baseCurrency = (document.getElementById('stockBaseCurrency')?.value || 'EUR').trim().toUpperCase();

        const stocks = getStocksData();
        if (!stocks.length) {
            container.innerHTML = '';
            if (emptyMsg) emptyMsg.style.display = '';
            return;
        }

        const groups = new Map();

        function toNum(x) {
            const n = parseFloat(String(x ?? '').replace(',', '.'));
            return isFinite(n) ? n : 0;
        }

        stocks.forEach(s => {
            const stockSymbol = String(s.stockName || '').trim() || 'UNKNOWN';
            const currency = String((s.currencyBase || s.currency || '')).trim();
            const qty = toNum(s.quantity);
            const price = toNum((s.priceBase != null ? s.priceBase : s.price));
            const fee = toNum((s.feeBase != null ? s.feeBase : s.fee));

            // Group by stock + currency (keeps numbers honest if user mixes currencies).
            const key = `${stockSymbol}||${currency}`;
            if (!groups.has(key)) {
                groups.set(key, {
                    stockSymbol,
                    currency,
                    totalQty: 0,
                    totalValuePaid: 0,
                    totalFee: 0,
                    txCount: 0,
                });
            }
            const g = groups.get(key);
            g.totalQty += qty;
            g.totalFee += fee;
            g.totalValuePaid += (qty * price) + fee;
            g.txCount += 1;
        });

        const list = Array.from(groups.values());
        list.sort((a, b) => (b.totalValuePaid - a.totalValuePaid));

        container.innerHTML = list.map(g => {
            const avgBuy = g.totalQty ? ((g.totalValuePaid - g.totalFee) / g.totalQty) : 0;
            const cur = g.currency ? ` ${g.currency}` : (baseCurrency ? ` ${baseCurrency}` : '');
            const symbol = String(g.stockSymbol || '').toUpperCase();
            return `
                <div class="totals-card" data-stock-symbol="${symbol}" data-stock-qty="${g.totalQty}" data-stock-paid="${g.totalValuePaid}">
                    <div class="totals-header">
                        <div>
                            <div style="font-size:1rem;font-weight:700">
                                <span class="stock-symbol">${symbol}</span>
                                <span class="stock-name small-muted" style="margin-left:8px; font-weight:600;"></span>
                            </div>
                        </div>
                        <div class="pct-badge pct-neutral" data-stock-pct>—</div>
                    </div>

                    <div class="totals-meta">
                        <div class="totals-row">
                            <span class="totals-label small-muted">Total Quantity:</span>
                            <span class="totals-value">${formatNumber(g.totalQty, 6)}</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Total Value Now:</span>
                            <span class="totals-value" data-stock-now>—</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Total Value Paid:</span>
                            <span class="totals-value">${formatNumber(g.totalValuePaid, 2)}${cur}</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Unit price now:</span>
                            <span class="totals-value" data-stock-live>—</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Avg Buy Price:</span>
                            <span class="totals-value">${formatNumber(avgBuy, 4)}${cur}</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Fees paid:</span>
                            <span class="totals-value">${formatNumber(g.totalFee, 2)}${cur}</span>
                        </div>
                        <div class="totals-row">
                            <span class="totals-label small-muted">Gain / Loss:</span>
                            <span class="totals-value" data-stock-gl>—</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        if (emptyMsg) emptyMsg.style.display = 'none';

        // Fill live quote fields asynchronously.
        hydrateStockPortfolioLiveQuotes();
    }

    function showStockPortfolio() {
        const title = document.getElementById('stockPageTitle');
        const panel = document.getElementById('stockPanel');
        const newDiv = document.getElementById('newStock');
        const listDiv = document.getElementById('stockListDiv');
        const updateDiv = document.getElementById('updateStockDiv');

        if (title) title.innerText = 'Stock Portfolio';
        if (panel) panel.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';

        buildStockPortfolio();
        setStockNavVisibility('portfolio');
    }

    let stockQuoteInFlight = new Set();
    async function hydrateStockPortfolioLiveQuotes() {
        const cards = Array.from(document.querySelectorAll('#stockPortfolioCards [data-stock-symbol]'));
        for (const card of cards) {
            const symbol = String(card.getAttribute('data-stock-symbol') || '').trim();
            if (!symbol) continue;
            if (stockQuoteInFlight.has(symbol)) continue;
            stockQuoteInFlight.add(symbol);

            try {
                const res = await fetch(`/stock/quote?symbol=${encodeURIComponent(symbol)}`);
                const data = await res.json();
                if (!res.ok) {
                    console.warn('[stock] portfolio quote failed', symbol, res.status, data && (data.error || data.details) ? (data.error || data.details) : data);
                }
                const price = (data && typeof data.priceBase === 'number') ? data.priceBase : ((data && typeof data.price === 'number') ? data.price : null);

                const qty = parseFloat(card.getAttribute('data-stock-qty') || '0') || 0;
                const paid = parseFloat(card.getAttribute('data-stock-paid') || '0') || 0;

                const liveEl = card.querySelector('[data-stock-live]');
                const nowEl = card.querySelector('[data-stock-now]');
                const glEl = card.querySelector('[data-stock-gl]');
                const pctEl = card.querySelector('[data-stock-pct]');
                const nameEl = card.querySelector('.stock-name');

                const curCode = (data && data.currencyBase) ? data.currencyBase : (data && data.currency ? data.currency : '');
                const cur = curCode ? ` ${curCode}` : '';
                if (nameEl && data && data.name) nameEl.textContent = data.name;

                if (price === null) {
                    if (data && data.provider) {
                        console.warn('[stock] portfolio quote missing price', symbol, 'provider=', data.provider, data);
                    }
                    if (liveEl) liveEl.textContent = '—';
                    if (nowEl) nowEl.textContent = '—';
                    if (glEl) glEl.textContent = '—';
                    if (pctEl) {
                        pctEl.textContent = '—';
                        pctEl.classList.remove('pct-positive','pct-negative');
                        pctEl.classList.add('pct-neutral');
                    }
                    continue;
                }

                const valueNow = qty * price;
                const gl = valueNow - paid;
                const pct = paid ? (gl / paid) * 100 : 0;

                if (liveEl) liveEl.textContent = `${formatNumber(price, 4)}${cur}`;
                if (nowEl) nowEl.textContent = `${formatNumber(valueNow, 2)}${cur}`;

                if (glEl) {
                    const sign = gl >= 0 ? '+' : '';
                    glEl.textContent = `${sign}${formatNumber(gl, 2)}${cur}`;
                    glEl.classList.remove('pct-positive','pct-negative','pct-neutral');
                    glEl.classList.add(gl >= 0 ? 'pct-positive' : 'pct-negative');
                }

                if (pctEl) {
                    pctEl.textContent = `${pct >= 0 ? '+' : ''}${formatNumber(pct, 2)}%`;
                    pctEl.classList.remove('pct-positive','pct-negative','pct-neutral');
                    pctEl.classList.add(pct >= 0 ? 'pct-positive' : 'pct-negative');
                }
            } catch (e) {
                // Keep placeholders
            } finally {
                stockQuoteInFlight.delete(symbol);
            }
        }
    }

    // Crypto-like autocomplete powered by backend stock search/quote endpoints.
    // - User can type symbol or name
    // - Dropdown suggests "SYMBOL - Company Name"
    // - Hidden input stores the symbol
    // - Optionally auto-fills price/currency from /stock/quote
    function initStockAutocomplete(inputId, listWrapId, hiddenId, opts) {
        const input = document.getElementById(inputId);
        const listWrap = document.getElementById(listWrapId);
        const hidden = document.getElementById(hiddenId);
        const priceEl = (opts && opts.priceId) ? document.getElementById(opts.priceId) : null;
        const currencyEl = (opts && opts.currencyId) ? document.getElementById(opts.currencyId) : null;
        if (!input || !listWrap || !hidden) return;

        let currentFocus = -1;
        let lastController = null;
        let lastQuotedSymbol = '';

        function showError(inputElem, msg) {
            if (!inputElem || !inputElem.parentNode) return;
            clearError(inputElem);
            const span = document.createElement('span');
            span.className = 'field-error';
            span.style.color = '#c62828';
            span.style.fontSize = '12px';
            span.style.display = 'block';
            span.style.marginTop = '6px';
            span.textContent = msg;

            const label = inputElem.parentNode.querySelector('label');
            if (label) {
                label.appendChild(span);
                return;
            }
            inputElem.parentNode.appendChild(span);
        }

        function clearError(inputElem) {
            if (!inputElem || !inputElem.parentNode) return;
            const existing = inputElem.parentNode.querySelector('.field-error');
            if (existing) existing.parentNode.removeChild(existing);
        }

        function extractSymbol(raw) {
            const txt = String(raw || '').trim();
            if (!txt) return '';
            // If user selected an option, input can be "SYM - Name".
            if (txt.includes(' - ')) {
                const first = txt.split(' - ')[0].trim();
                return first.replace(/\(.+\)$/, '').trim().toUpperCase();
            }
            // If user typed a raw symbol, accept only strict symbol-like strings.
            // (Avoid treating company names as symbols.)
            if (/\s/.test(txt)) return '';
            if (!/^[A-Za-z0-9.\-]+$/.test(txt)) return '';
            const upper = txt.toUpperCase();
            // Most tickers are short; keep a conservative max to reduce false positives.
            if (upper.length > 12) return '';
            return upper;
        }

        function setHiddenFromInput() {
            hidden.value = extractSymbol(input.value);
        }

        async function tryMatchAndSetFromSearch() {
            setHiddenFromInput();
            const sym = String(hidden.value || '').trim().toUpperCase();
            if (!sym) return false;
            if (!/^[A-Z0-9.\-]+$/.test(sym)) return false;

            // If it came from a list click, trust it (same spirit as crypto: must come from list).
            if (String(hidden.dataset.fromList || '') === '1') {
                // Keep whatever label the user selected (usually "SYM - Name").
                hidden.value = sym;
                return true;
            }

            // Otherwise, validate by checking that /stock/search can find this symbol.
            try {
                const res = await fetch(`/stock/search?q=${encodeURIComponent(sym)}`);
                const data = await res.json();
                if (!res.ok) return false;
                const results = Array.isArray(data && data.results) ? data.results : [];
                const match = results.find(r => String(r && r.symbol || '').trim().toUpperCase() === sym);
                if (!match) return false;
                const nm = String(match && match.name || '').trim();
                input.value = nm ? `${sym} - ${nm}` : sym;
                hidden.value = sym;
                return true;
            } catch (e) {
                return false;
            }
        }

        function closeAllLists(elmnt) {
            const x = document.getElementsByClassName('autocomplete-items');
            for (let i = x.length - 1; i >= 0; i--) {
                if (elmnt !== x[i] && elmnt !== input) {
                    x[i].parentNode && x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add('autocomplete-active');
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove('autocomplete-active');
            }
        }

        function ensureSelectHasOption(selectEl, value) {
            if (!selectEl || !value) return;
            if (String(selectEl.tagName || '').toUpperCase() !== 'SELECT') return;
            const v = String(value).trim().toUpperCase();
            if (!v) return;
            const exists = Array.from(selectEl.options || []).some(o => String(o.value || '').toUpperCase() === v);
            if (exists) return;
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            selectEl.appendChild(opt);
        }

        async function fillQuote(symbol) {
            const sym = String(symbol || '').trim().toUpperCase();
            if (!sym) return;
            if (lastQuotedSymbol === sym) return;
            lastQuotedSymbol = sym;

            try {
                const res = await fetch(`/stock/quote?symbol=${encodeURIComponent(sym)}`);
                const data = await res.json();
                if (!res.ok) {
                    console.warn('[stock] quote failed', res.status, data && data.error ? data.error : data);
                }
                // Keep input as the symbol only; name stays in the dropdown suggestions.
                if (priceEl && (String(priceEl.value || '').trim() === '') && data && typeof data.price === 'number') {
                    // Prefer website/base currency quote if available.
                    if (typeof data.priceBase === 'number') priceEl.value = String(data.priceBase);
                    else priceEl.value = String(data.price);
                }
                if (currencyEl && (String(currencyEl.value || '').trim() === '') && data && data.currency) {
                    const desired = data.currencyBase ? String(data.currencyBase) : String(data.currency);
                    ensureSelectHasOption(currencyEl, desired);
                    currencyEl.value = String(desired);
                }
            } catch (e) {
                console.warn('[stock] quote exception', e);
            }
        }

        function commitSelection(symbol, name) {
            const sym = String(symbol || '').trim().toUpperCase();
            if (!sym) return;
            // Crypto-like: show a friendly label, but store only the symbol.
            const nm = String(name || '').trim();
            input.value = nm ? `${sym} - ${nm}` : sym;
            hidden.value = sym;
            hidden.dataset.fromList = '1';
            clearError(input);
            closeAllLists();
            fillQuote(sym);
        }

        input.addEventListener('input', async function () {
            const q = String(input.value || '').trim();
            setHiddenFromInput();
            hidden.dataset.fromList = '0';
            clearError(input);
            closeAllLists();
            currentFocus = -1;
            if (!q || q.length < 2) return;

            const list = document.createElement('div');
            list.setAttribute('class', 'autocomplete-items');
            if (!listWrap.style.position) listWrap.style.position = 'relative';
            list.style.position = 'absolute';
            list.style.zIndex = 1000;
            list.style.left = '0px';
            list.style.right = '0px';
            list.style.top = '4px';
            list.style.maxHeight = '260px';
            list.style.overflowY = 'auto';
            listWrap.appendChild(list);

            try {
                if (lastController) lastController.abort();
                lastController = new AbortController();
                const res = await fetch(`/stock/search?q=${encodeURIComponent(q)}`, { signal: lastController.signal });
                const data = await res.json();
                if (!res.ok) {
                    console.warn('[stock] search failed', res.status, data && data.error ? data.error : data);
                }
                const results = Array.isArray(data && data.results) ? data.results : [];

                results.slice(0, 20).forEach(r => {
                    const sym = String(r.symbol || '').trim().toUpperCase();
                    const nm = String(r.name || '').trim();
                    const region = String(r.region || '').trim();
                    const cur = String(r.currency || '').trim();

                    if (!sym) return;

                    const item = document.createElement('div');
                    const meta = [region, cur].filter(Boolean).join(' / ');
                    item.innerHTML = `<strong>${sym}</strong>${nm ? ` - ${nm}` : ''}${meta ? ` <span class="small-muted">(${meta})</span>` : ''}`;
                    item.addEventListener('click', function () {
                        commitSelection(sym, nm);
                    });
                    item.addEventListener('touchstart', function (e) {
                        e.preventDefault();
                        commitSelection(sym, nm);
                    });
                    // Prefer committing selection before input blur fires.
                    item.addEventListener('mousedown', function () {
                        commitSelection(sym, nm);
                    });
                    list.appendChild(item);
                });
            } catch (e) {
                if (!(e && e.name === 'AbortError')) {
                    console.warn('[stock] search exception', e);
                }
            }
        });

        input.addEventListener('keydown', function (e) {
            let x = document.getElementsByClassName('autocomplete-items');
            if (x.length) x = x[0].getElementsByTagName('div');
            if (e.keyCode === 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode === 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode === 13) {
                if (currentFocus > -1) {
                    e.preventDefault();
                    if (x && x[currentFocus]) x[currentFocus].click();
                }
            }
        });

        input.addEventListener('blur', function () {
            // Small timeout to allow click selection to commit first.
            setTimeout(async () => {
                const ok = await tryMatchAndSetFromSearch();
                if (!ok) {
                    // Clear free text and hidden value (crypto-like: must be a real item).
                    input.value = '';
                    hidden.value = '';
                    hidden.dataset.fromList = '0';
                    showError(input, 'Please select a stock from the suggestions.');
                    return;
                }
                clearError(input);
                const sym = String(hidden.value || '').trim().toUpperCase();
                if (sym) fillQuote(sym);
            }, 150);
        });

        const form = input.closest('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                // Async validation (same end result as crypto): block submit unless the
                // input matches an actual symbol.
                e.preventDefault();
                (async () => {
                    const ok = await tryMatchAndSetFromSearch();
                    if (!ok) {
                        showError(input, 'You must choose a stock from the suggestions before submitting.');
                        try { input.focus(); } catch (_) {}
                        return;
                    }
                    clearError(input);
                    form.submit();
                })();
                return false;
            });
        }

        document.addEventListener('click', function (e) {
            closeAllLists(e.target);
        });
    }

    function showStockNew() {
        const title = document.getElementById('stockPageTitle');
        const panel = document.getElementById('stockPanel');
        const newDiv = document.getElementById('newStock');
        const listDiv = document.getElementById('stockListDiv');
        const updateDiv = document.getElementById('updateStockDiv');

        if (title) title.innerText = 'New Stock Transaction';
        if (panel) panel.style.display = 'none';
        if (newDiv) newDiv.style.display = 'block';
        if (listDiv) listDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';
        setStockNavVisibility('new');
    }

    function showStockHistory() {
        const title = document.getElementById('stockPageTitle');
        const panel = document.getElementById('stockPanel');
        const newDiv = document.getElementById('newStock');
        const listDiv = document.getElementById('stockListDiv');
        const updateDiv = document.getElementById('updateStockDiv');

        if (title) title.innerText = 'Stocks Transactions History';
        if (panel) panel.style.display = 'none';
        if (listDiv) listDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';
        setStockNavVisibility('history');

        if (typeof applyStockFilters === 'function') { applyStockFilters(); }
    }

    function showStockUpdate() {
        const title = document.getElementById('stockPageTitle');
        const panel = document.getElementById('stockPanel');
        const newDiv = document.getElementById('newStock');
        const listDiv = document.getElementById('stockListDiv');
        const updateDiv = document.getElementById('updateStockDiv');

        if (title) title.innerText = 'Update Stock Transaction';
        if (panel) panel.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';

        // Update view doesn't have its own nav button.
        setStockNavVisibility('update');
    }

    function editStock(stockId, userId, stockName, tdate, fromWallet, toWallet, operation, quantity, price, currency, fee, note) {
        document.getElementById("updateStockId").value = stockId;
        document.getElementById("updateUserId").value = userId;
        const hidden = document.getElementById("updateStockName");
        const visible = document.getElementById("updateStockSearch");
        const sym = (stockName || '').toUpperCase();
        if (hidden) {
            hidden.value = sym;
            // Treat the existing saved symbol as already-selected so blur/submit validators
            // don't clear it just because we didn't pick it from today's autocomplete list.
            hidden.dataset.fromList = sym ? '1' : '0';
        }
        if (visible) visible.value = sym;
        {
            const el = document.getElementById("updateTdate");
            if (el && el._flatpickr) {
                el._flatpickr.setDate(tdate, false, "Y-m-d\\TH:i");
            } else if (el) {
                el.value = tdate;
            }
        }
        document.getElementById("updateFromWallet").value = fromWallet;
        document.getElementById("updateToWallet").value = toWallet;
        {
            const opEl = document.getElementById("updateOperation");
            if (opEl) opEl.value = operation || '';
        }
        document.getElementById("updateQuantity").value = quantity;
        document.getElementById("updatePrice").value = price;
        document.getElementById("updateCurrency").value = currency;
        document.getElementById("updateFee").value = fee;
        document.getElementById("updateNote").value = note;
        showStockUpdate();
        // Route is lowercase in the blueprint: /deletestock/<stock_id>/<user_id>
        document.getElementById("deleteForm").action = `/deletestock/${stockId}/${userId}`;

        // Best-effort: resolve and show company name, but never overwrite if the user started editing.
        if (visible && sym) {
            const requestSym = sym;
            fetch(`/stock/quote?symbol=${encodeURIComponent(requestSym)}`)
                .then(r => r.json())
                .then(d => {
                    if (!visible) return;
                    // Only fill the label if the field still shows just the symbol.
                    const current = String(visible.value || '').trim().toUpperCase();
                    const hiddenSym = hidden ? String(hidden.value || '').trim().toUpperCase() : '';
                    if (hiddenSym !== requestSym) return;
                    if (current !== requestSym) return;
                    if (d && d.name) visible.value = `${requestSym} - ${d.name}`;
                })
                .catch(() => {});
        }
    }  

    function editStockFromRow(buttonEl) {
        const li = buttonEl?.closest('li[data-id]');
        if (!li) return;
        editStock(
            li.dataset.id,
            li.dataset.userid,
            li.dataset.stock,
            li.dataset.tdate,
            li.dataset.from,
            li.dataset.to,
            li.dataset.operation,
            li.dataset.qty,
            li.dataset.price,
            li.dataset.currency,
            li.dataset.fee,
            li.dataset.note
        );
    }

    function parseLocalDateTime(dateStr) {
        // Accepts: YYYY-MM-DDTHH:mm from flatpickr config; parse as local.
        const s = String(dateStr || '').trim();
        if (!s) return null;
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
        if (!m) return null;
        return new Date(
            parseInt(m[1], 10),
            parseInt(m[2], 10) - 1,
            parseInt(m[3], 10),
            parseInt(m[4], 10),
            parseInt(m[5], 10),
            0,
            0
        );
    }

    function parseTxDate(dateStr) {
        // Most tx dates are ISO-like without timezone; parse as local.
        const d = parseLocalDateTime(dateStr);
        if (d) return d;
        if (!dateStr) return null;
        const fallback = new Date(dateStr);
        return isNaN(fallback) ? null : fallback;
    }

    function monthKeyFromDate(d) {
        if (!d || isNaN(d)) return 'unknown';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
    }

    function monthLabelFromDate(d) {
        if (!d || isNaN(d)) return 'Unknown date';
        try {
            return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
    }

    function buildStockMonthGroups() {
        const list = document.getElementById('stockList');
        if (!list) return;

        // Remove existing headers
        list.querySelectorAll('li.crypto-group-header').forEach(h => h.remove());

        // Only group real transaction items
        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        if (!txItems.length) return;

        let currentKey = null;
        txItems.forEach(li => {
            const d = parseTxDate(li.getAttribute('data-tdate'));
            const key = monthKeyFromDate(d);
            li.setAttribute('data-group', key);

            if (key !== currentKey) {
                const header = document.createElement('li');
                header.className = 'crypto-group-header';
                header.setAttribute('data-group', key);
                header.textContent = monthLabelFromDate(d);
                list.insertBefore(header, li);
                currentKey = key;
            }
        });
    }

    function syncStockGroupHeaders() {
        const list = document.getElementById('stockList');
        if (!list) return;

        const headers = Array.from(list.querySelectorAll('li.crypto-group-header'));
        if (!headers.length) return;

        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        headers.forEach(h => {
            const key = h.getAttribute('data-group') || '';
            const anyVisible = txItems.some(li => {
                if ((li.getAttribute('data-group') || '') !== key) return false;
                return li.style.display !== 'none';
            });
            h.style.display = anyVisible ? '' : 'none';
        });
    }

    function ensureStockGroupsBuilt(force) {
        const list = document.getElementById('stockList');
        if (!list) return;
        const hasHeaders = !!list.querySelector('li.crypto-group-header');
        if (force || !hasHeaders) {
            buildStockMonthGroups();
        }
        syncStockGroupHeaders();
    }

    function applyStockFilters() {
        const list = document.getElementById('stockList');
        if (!list) return;
        // Ensure month/year grouping headers exist, but only filter real tx items
        ensureStockGroupsBuilt(false);
        const items = Array.from(list.querySelectorAll('li[data-tdate]'));

        const startVal = document.getElementById('stockFilterStart')?.value || '';
        const endVal = document.getElementById('stockFilterEnd')?.value || '';
        const stockVal = (document.getElementById('stockFilterSymbol')?.value || '').trim().toLowerCase();
        const noteVal = (document.getElementById('stockFilterNote')?.value || '').trim().toLowerCase();
        const fromVal = String(document.getElementById('stockFilterFromWallet')?.value || '').trim();
        const toVal = String(document.getElementById('stockFilterToWallet')?.value || '').trim();

        const startDt = parseLocalDateTime(startVal);
        const endDt = parseLocalDateTime(endVal);

        if (window.stockPageSize == null) window.stockPageSize = 20;
        if (window.stockCurrentPage == null) window.stockCurrentPage = 1;

        function itemMatches(li) {
            let show = true;
            const tdate = parseTxDate(li.getAttribute('data-tdate'));
            if (startDt && tdate && tdate < startDt) show = false;
            if (endDt && tdate && tdate > endDt) show = false;
            if ((startDt || endDt) && !tdate) show = false;

            if (show && stockVal) {
                const sym = (li.getAttribute('data-stock') || '').toLowerCase();
                if (!sym.includes(stockVal)) show = false;
            }
            if (show && noteVal) {
                const noteAttr = (li.getAttribute('data-note') || '').toLowerCase();
                if (!noteAttr.includes(noteVal)) show = false;
            }
            if (show && fromVal) {
                const fromAttrRaw = String(li.getAttribute('data-from') || '').trim();
                const fromAttr = fromAttrRaw.toLowerCase();
                const needle = fromVal.toLowerCase();
                // Prefer exact match (wallet id), fall back to substring match for older records.
                if (fromAttrRaw !== fromVal && !fromAttr.includes(needle)) show = false;
            }
            if (show && toVal) {
                const toAttrRaw = String(li.getAttribute('data-to') || '').trim();
                const toAttr = toAttrRaw.toLowerCase();
                const needle = toVal.toLowerCase();
                if (toAttrRaw !== toVal && !toAttr.includes(needle)) show = false;
            }
            return show;
        }

        const matching = items.filter(itemMatches);
        const total = matching.length;
        const pageSize = Number(window.stockPageSize) || 20;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        window.stockCurrentPage = Math.min(Math.max(1, Number(window.stockCurrentPage) || 1), totalPages);

        items.forEach(li => { li.style.display = 'none'; });

        const startIdx = (window.stockCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        matching.slice(startIdx, endIdx).forEach(li => { li.style.display = ''; });

        syncStockGroupHeaders();

        const emptyMsg = document.getElementById('stockFilterEmptyMsg');
        if (emptyMsg) emptyMsg.style.display = total ? 'none' : '';

        const pager = document.getElementById('stockPagination');
        const pageInfo = document.getElementById('stockPageInfo');
        const prevBtn = document.getElementById('stockPrevPage');
        const nextBtn = document.getElementById('stockNextPage');
        if (pager) pager.style.display = total ? '' : 'none';
        if (pageInfo) pageInfo.textContent = `Page ${window.stockCurrentPage} of ${totalPages}`;
        if (prevBtn) prevBtn.disabled = window.stockCurrentPage <= 1;
        if (nextBtn) nextBtn.disabled = window.stockCurrentPage >= totalPages;
    }

    function resetStockFilters() {
        ['stockFilterStart','stockFilterEnd','stockFilterSymbol','stockFilterNote','stockFilterFromWallet','stockFilterToWallet'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el._flatpickr) {
                el._flatpickr.clear();
                return;
            }
            el.value = '';
        });
        window.stockCurrentPage = 1;
        applyStockFilters();
    }

    function stockGoToPrevPage() {
        window.stockCurrentPage = Math.max(1, (Number(window.stockCurrentPage) || 1) - 1);
        applyStockFilters();
    }

    function stockGoToNextPage() {
        window.stockCurrentPage = (Number(window.stockCurrentPage) || 1) + 1;
        applyStockFilters();
    }

document.addEventListener("DOMContentLoaded", function() {
    let list = document.getElementById("stockList");
    if (list) {
        let items = Array.from(list.querySelectorAll('li[data-tdate]'));

        items.sort((a, b) => {
            let dateA = parseTxDate(a.getAttribute("data-tdate")) || new Date(0);
            let dateB = parseTxDate(b.getAttribute("data-tdate")) || new Date(0);
            return dateB - dateA;  // Sort descending
        });

        items.forEach(item => list.appendChild(item));
        ensureStockGroupsBuilt(true);
    }

    // Default view: Portfolio.
    showStockPortfolio();

    initStockAutocomplete('stockSearch', 'stockSearchList', 'stockName', { priceId: 'stockPrice', currencyId: 'stockCurrency' });
    initStockAutocomplete('updateStockSearch', 'updateStockSearchList', 'updateStockName', { priceId: 'updatePrice', currencyId: 'updateCurrency' });

    // Wire filter events (if filters exist)
    ['stockFilterStart','stockFilterEnd','stockFilterSymbol','stockFilterNote','stockFilterFromWallet','stockFilterToWallet'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        ['input','change'].forEach(evt => {
            el.addEventListener(evt, function () {
                window.stockCurrentPage = 1;
                applyStockFilters();
            });
        });
    });
});

// Keep these names for menu/sidebar compatibility.
function newStockDiv() { showStockNew(); }
function stockHistoryDiv() { showStockHistory(); }
</script>

<div class="crypto-page-header">
    <h1 class="crypto-page-title" id="stockPageTitle">Stock Portfolio</h1>
</div>

<!-- Mobile-only subnav (sidebar is hidden on small screens) -->
<div class="app-subnav app-subnav-mobile" aria-label="Stock sections">
    <button type="button" class="app-subnav-link" data-stock-nav="new" onclick="newStockDiv()">New</button>
    <button type="button" class="app-subnav-link" data-stock-nav="portfolio" onclick="showStockPortfolio()">Portfolio</button>
    <button type="button" class="app-subnav-link" data-stock-nav="history" onclick="stockHistoryDiv()">History</button>
</div>


<div id="stockPanel" class="panel" style="padding:12px;margin-bottom:12px;">
    <div id="stockPortfolioEmpty" style="display:none;">No stock transactions to summarize.</div>
    {% if fx_warning %}
    <div class="small-muted" style="margin-bottom:8px;">
        Some transactions could not be converted to {{ base_currency|default('EUR') }} (FX unavailable). Portfolio values may be approximate.
    </div>
    {% endif %}
    <div id="stockPortfolioCards" class="totals-grid"></div>
</div>

<div id="newStock" class="block-new" style="display: none;">
    <!-- <h2 class="center-text">Add New Stock Transaction</h2> -->
    <div class="form-container">

    <form action="/stock" method="POST">
        <div>
        <label for="stockName">Stock:</label>
        <input type="text" id="stockSearch" autocomplete="off" required>
        <div id="stockSearchList"></div>
        <input type="hidden" name="stockName" id="stockName">
        </div>
        <div>
        <label for="tdate">Date:</label>
        <input type="text" id="tdate" name="tdate" data-dt-picker="1" required>
        </div>
        <div>
        <label for="fromWallet">From Wallet:</label>
        <select name="fromWallet" id="fromWallet" >
            <option value="">-- Select Wallet --</option>
            {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
            <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
            {% endfor %}
        </select>
        </div>
        <div>
        <label for="toWallet">To Wallet:</label>
        <select name="toWallet" id="toWallet" required>
            <option value="">-- Select Wallet --</option>
            {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
            <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
            {% endfor %}
        </select>
        </div>
        <div>
        <label for="operation">Side:</label>
        <select name="operation" id="operation" required>
            <option value="">-- Select Side --</option>
            <option value="Buy">Buy</option>
            <option value="Sell">Sell</option>
        </select>
        </div>
        <div>
        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" step="any" inputmode="decimal" required>
        </div>
        <div>
        <label for="price">Price:</label>
        <input type="number" id="stockPrice" name="price" step="any" inputmode="decimal" required>
        </div>
        <div>
        <label for="currency">Currency:</label>
        <select id="stockCurrency" name="currency" required>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
            <option value="GBX">GBX</option>
            <option value="CHF">CHF</option>
            <option value="CAD">CAD</option>
            <option value="AUD">AUD</option>
            <option value="JPY">JPY</option>
            <option value="SEK">SEK</option>
            <option value="NOK">NOK</option>
            <option value="DKK">DKK</option>
        </select>
        </div>
        <div>
        <label for="fee">Fee:</label>
        <input type="number" id="fee" name="fee" step="any" inputmode="decimal">
        </div>
        <div>
        <label for="note">Note:</label>
        <input type="text" name="note">
        </div>
                <div>
                    <button type="submit" class="btn-insert pct-positive">Insert</button>
                    <button type="reset" class="btn-clear">Clear</button>
                    <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
                </div>
            </form>

    </div>
</div>
    

<div id="stockListDiv" class="form-container" style="display:none;">
    <!-- <h2 class="crypto-section-title">Stocks Transactions History</h2> -->
    <div id="stockFilters" class="history-filters">
        <form class="filters-grid" onsubmit="applyStockFilters(); return false;">
            <div>
                <label for="stockFilterStart">From Date:</label>
                <input type="text" id="stockFilterStart" name="start" data-dt-picker="1">
            </div>
            <div>
                <label for="stockFilterEnd">To Date:</label>
                <input type="text" id="stockFilterEnd" name="end" data-dt-picker="1">
            </div>
            <div>
                <label for="stockFilterSymbol">Stock:</label>
                <input type="text" id="stockFilterSymbol" name="stock" placeholder="Symbol" autocomplete="off" />
            </div>
            <div>
                <label for="stockFilterNote">Note:</label>
                <input type="text" id="stockFilterNote" name="note" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="stockFilterFromWallet">From Wallet:</label>
                <select id="stockFilterFromWallet" name="fromWallet">
                    <option value="">All</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="stockFilterToWallet">To Wallet:</label>
                <select id="stockFilterToWallet" name="toWallet">
                    <option value="">All</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filters-actions">
                <button type="button" class="btn-clear" onclick="resetStockFilters()">Clear</button>
            </div>
        </form>
        <div id="stockFilterEmptyMsg" class="small-muted" style="display:none;margin-top:8px">No matching transactions.</div>
        <div id="stockPagination" class="pagination-controls" style="display:none;margin-top:10px">
            <button id="stockPrevPage" type="button" class="btn-clear" onclick="stockGoToPrevPage()">Prev</button>
            <div id="stockPageInfo" class="small-muted" style="min-width:140px;text-align:center">Page 1 of 1</div>
            <button id="stockNextPage" type="button" class="btn-clear" onclick="stockGoToNextPage()">Next</button>
        </div>
    </div>
{% if stocks %}
<ul id="stockList">
    {% for stock in stocks %}
    {% set _op = stock.operation|default(stock.side, true)|default('', true) %}
    {% set _note = stock.note|default('', true) %}
    <li data-id="{{ stock.stockId }}" data-userid="{{ stock.userId }}" data-tdate="{{ stock.tdate }}" data-stock="{{ stock.stockName }}" data-operation="{{ '' if _op == 'None' else _op }}" data-qty="{{ stock.quantity }}" data-price="{{ stock.price }}" data-currency="{{ stock.currency }}" data-fee="{{ stock.fee|default(0, true) }}" data-note="{{ '' if _note == 'None' else _note }}" data-from="{{ stock.fromWallet }}" data-to="{{ stock.toWallet }}">
        <div class="crypto-history-row">
            <div class="crypto-history-left">
                <div class="crypto-history-title">{{ stock.stockName }}</div>
                {% if _op and _op != 'None' %}
                <div class="crypto-history-sub">{{ _op }}</div>
                {% endif %}
                {% if _note and _note != 'None' %}
                <div class="crypto-history-sub">{{ _note }}</div>
                {% endif %}
            </div>

            <div class="crypto-history-right">
                <div class="crypto-history-amount">{{ stock.quantity }}</div>
                <div class="crypto-history-sub">{{ stock.price }}{% if stock.currency %} {{ stock.currency }}{% endif %}</div>
            </div>

            <div class="crypto-history-actions">
                <button class="btn-insert" type="button" onclick="editStockFromRow(this)">Edit</button>
            </div>
        </div>
    </li>
    {% endfor %}
</ul>

</div>

{% else %}
<p>No stocks found.</p>
{% endif %}

<div id="updateStockDiv" class="block-update" style="display: none;">
    <!-- <h2 class="center-text">Update Stock Transaction</h2> -->
    <div class="form-container">
        <form id="updateForm" action="/updateStock" method="POST">
            <input type="hidden" id="updateStockId" name="stockId">
            <input type="hidden" id="updateUserId" name="userId">
            <div>
                <label>Stock:</label>
                <input type="text" id="updateStockSearch" autocomplete="off" required>
                <div id="updateStockSearchList"></div>
                <input type="hidden" id="updateStockName" name="stockName">
            </div>
            <div>
                <label>Date:</label>
                <input type="text" id="updateTdate" name="tdate" data-dt-picker="1">
            </div>
            <div>
                <label>From Wallet:</label>
                <select id="updateFromWallet" name="fromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>To Wallet:</label>
                <select id="updateToWallet" name="toWallet" required>
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="updateOperation">Side:</label>
                <select name="operation" id="updateOperation" required>
                    <option value="">-- Select Side --</option>
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                </select>
            </div>
            <div>
                <label>Quantity:</label>
                <input type="number" id="updateQuantity" name="quantity" step="any" inputmode="decimal" required>
            </div>
            <div>
                <label>Price:</label>
                <input type="number" id="updatePrice" name="price" step="any" inputmode="decimal" required>
            </div>
            <div>
                <label>Currency:</label>
                <select id="updateCurrency" name="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="GBX">GBX</option>
                    <option value="CHF">CHF</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                    <option value="JPY">JPY</option>
                    <option value="SEK">SEK</option>
                    <option value="NOK">NOK</option>
                    <option value="DKK">DKK</option>
                </select>
            </div>
            <div>
                <label>Fee:</label>
                <input type="number" id="updateFee" name="fee" step="any" inputmode="decimal">
            </div>
            <div>
                <label>Note:</label>
                <input type="text" id="updateNote" name="note">
            </div>
            <div>
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="submit" form="deleteForm" class="btn-delete" onclick="return confirm('Are you sure?')">Delete</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>

    <form id="deleteForm" method="POST"></form>
</div>

{% endblock %}
