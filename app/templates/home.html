{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}
<!-- <h1>Home</h1> -->
{% if session.get('user') %}
<!-- <h6>Username : {{ userId }}</h6> -->


<style>
    .grid-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 20px;
        height: auto;
        align-items: stretch;
    }
    .grid-item {
        display: flex;
        align-items: stretch;
        justify-content: stretch;
        min-height: 250px; 
    }

    .home-card {
        width: 100%;
        height: 100%;
        min-height: 320px;
    }
    #myChart {
        width: 100% !important;
        height: 100% !important;
    }

    @media (max-width: 768px) {
        .grid-container {
            grid-template-columns: 1fr; 
        }
    }
</style>

<div class="grid-container">
    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Wallet Balances</div>
            {% if wallets and wallets|length > 0 %}
                <div style="flex: 1 1 auto; min-height: 200px;">
                    <canvas id="walletChart"></canvas>
                </div>
            {% else %}
                <div class="small-muted" style="text-align: center; padding: 10px 0;">No wallets found</div>
            {% endif %}
        </div>
    </div>

    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Crypto Portfolio</div>
            <div style="flex: 1 1 auto; display: flex; align-items: center; justify-content: center;">
                <div style="width: 100%; max-width: 440px; height: 260px;">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div class="totals-meta" style="margin-top: 10px;">
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value now</div>
                    <div class="totals-value"><span class="pct-positive" id="sumNowText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value paid</div>
                    <div class="totals-value"><span class="pct-negative" id="sumPaidText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Gain / loss</div>
                    <div class="totals-value">
                        <span class="{% if cryptoPortfolioGainIsPositive %}pct-positive{% else %}pct-negative{% endif %}">
                            {% if cryptoPortfolioGainIsPositive %}+{% else %}-{% endif %}{{ cryptoPortfolioGainAbsDisplay }} {{ baseCurrency }}
                        </span>
                        <span class="small-muted">
                            {% if cryptoPortfolioGainPctDisplay and cryptoPortfolioGainPctDisplay != 'N/A' %}
                                ({{ cryptoPortfolioGainPctDisplay }})
                            {% else %}
                                (N/A)
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Stock Portfolio</div>
            <div style="flex: 1 1 auto; display: flex; align-items: center; justify-content: center;">
                <div style="width: 100%; max-width: 440px; height: 260px;">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
            <div class="totals-meta" style="margin-top: 10px;">
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value now</div>
                    <div class="totals-value"><span class="pct-positive" id="stockSumNowText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value paid</div>
                    <div class="totals-value"><span class="pct-negative" id="stockSumPaidText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Gain / loss</div>
                    <div class="totals-value">
                        <span class="{% if stockPortfolioGainIsPositive %}pct-positive{% else %}pct-negative{% endif %}">
                            {% if stockPortfolioGainIsPositive %}+{% else %}-{% endif %}{{ stockPortfolioGainAbsDisplay|default('0') }} {{ baseCurrency }}
                        </span>
                        <span class="small-muted">
                            {% if stockPortfolioGainPctDisplay and stockPortfolioGainPctDisplay != 'N/A' %}
                                ({{ stockPortfolioGainPctDisplay }})
                            {% else %}
                                (N/A)
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column; justify-content: center;">
            <div class="crypto-page-title" style="text-align: center; margin: 0; font-size: 1.1rem;">Transactions</div>
            <div class="small-muted" style="text-align: center; margin-top: 8px;">Overview coming soon.</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Wallet balances chart
    const walletItems = [
        {% if wallets and wallets|length > 0 %}
            {% for wallet in wallets %}
                {
                    name: {{ (wallet.walletName or wallet.walletId or '') | tojson }},
                    type: {{ (wallet.walletType or '') | tojson }},
                    currency: {{ (wallet.currency or '') | tojson }},
                    balance: {{ (wallet.balance or 0) | tojson }},
                    balanceBase: {{ (wallet.balanceBase or 0) | tojson }},
                    balanceWallet: {{ (wallet.balanceWallet or 0) | tojson }},
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        {% endif %}
    ];

    // Sort wallets by name (asc).
    if (Array.isArray(walletItems)) {
        walletItems.sort((a, b) => {
            const an = String(a?.name || '');
            const bn = String(b?.name || '');
            return an.localeCompare(bn);
        });
    }

    // Label format: "WalletName (CUR)".
    const walletLabels = (walletItems || []).map(w => {
        const name = String(w?.name || '').trim();
        const cur = String(w?.currency || '').trim();
        return cur ? `${name} (${cur})` : name;
    });
    // Bars are in base/setting currency.
    const walletBalances = (walletItems || []).map(w => Number(w?.balanceBase ?? w?.balance) || 0);

    const nowData = {{ cryptoNowValues | tojson }};
    const paidData = {{ cryptoPaidValues | tojson }};
    const stockNowData = {{ (stockNowValues or []) | tojson }};
    const stockPaidData = {{ (stockPaidValues or []) | tojson }};
    const baseCurrency = {{ (baseCurrency or 'EUR') | tojson }};
    const gainIsPositive = {{ (cryptoPortfolioGainIsPositive or false) | tojson }};
    const gainAbsDisplay = {{ (cryptoPortfolioGainAbsDisplay or '0') | tojson }};
    const gainPctDisplay = {{ (cryptoPortfolioGainPctDisplay or 'N/A') | tojson }};

    // Sum totals across all cryptos (overall portfolio)
    const sumNow = (Array.isArray(nowData) ? nowData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const sumPaid = (Array.isArray(paidData) ? paidData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const labels = ['Total Value Now', 'Total Value Paid'];

    const formatMoney = (v) => {
        const n = Number(v || 0);
        return `${n.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
    };

    // Fill below-chart totals
    const sumNowEl = document.getElementById('sumNowText');
    const sumPaidEl = document.getElementById('sumPaidText');
    if (sumNowEl) sumNowEl.textContent = formatMoney(sumNow);
    if (sumPaidEl) sumPaidEl.textContent = formatMoney(sumPaid);

    // Green for "Now", Red for "Paid"
    // Slightly muted ("matte") colors aligned with the app's green/red.
    const colorNow = 'rgba(76, 180, 100, 0.45)';
    const colorPaid = 'rgba(240, 87, 87, 0.45)';
    const borderNow = 'rgba(76, 180, 100, 0.9)';
    const borderPaid = 'rgba(240, 87, 87, 0.9)';

    // Render wallet bar chart (if the canvas exists)
    const walletCanvas = document.getElementById('walletChart');
    if (walletCanvas && Array.isArray(walletLabels) && walletLabels.length > 0) {
        const walletColors = walletBalances.map(v => (Number(v) || 0) >= 0 ? colorNow : colorPaid);
        const walletBorderColors = walletBalances.map(v => (Number(v) || 0) >= 0 ? borderNow : borderPaid);

        new Chart(walletCanvas, {
            type: 'bar',
            data: {
                labels: walletLabels,
                datasets: [
                    {
                        label: 'Balance',
                        data: walletBalances,
                        backgroundColor: walletColors,
                        borderColor: walletBorderColors,
                        borderWidth: 1,
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context && context[0] ? context[0].dataIndex : 0;
                                const w = (walletItems && walletItems[idx]) ? walletItems[idx] : {};
                                const name = String(w?.name || '').trim();
                                const type = String(w?.type || '').trim();
                                const cur = String(w?.currency || '').trim();
                                const bits = [name];
                                if (type) bits.push(type);
                                if (cur) bits.push(cur);
                                return bits.filter(Boolean).join(' - ');
                            },
                            label: function(context) {
                                const idx = context?.dataIndex ?? 0;
                                const w = (walletItems && walletItems[idx]) ? walletItems[idx] : {};

                                const vBase = Number(context.parsed.x || 0);
                                const vWallet = Number(w?.balanceWallet || 0);
                                const cur = String(w?.currency || '').trim();
                                const base = String(baseCurrency || '').trim();

                                const curUpper = cur ? cur.toUpperCase() : '';
                                const baseUpper = base ? base.toUpperCase() : '';

                                const a = base
                                    ? `${vBase.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${base}`
                                    : `${vBase.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
                                const b = cur
                                    ? `${vWallet.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${cur}`
                                    : `${vWallet.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

                                // If currencies are the same, show a single value (no repetition).
                                if (curUpper && baseUpper && curUpper === baseUpper) {
                                    return a;
                                }

                                // If one side is missing currency, fall back to showing the other.
                                if (baseUpper && !curUpper) return a;
                                if (!baseUpper && curUpper) return b;

                                return `${a} - ${b}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value) {
                                return `${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
                            }
                        },
                        grid: { display: true }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    new Chart(document.getElementById('myChart'), {
        type: 'pie',
        data: {
            labels,
            datasets: [
                {
                    label: `Crypto Portfolio (${baseCurrency})`,
                    data: [sumNow, sumPaid],
                    backgroundColor: [colorNow, colorPaid],
                    borderColor: [borderNow, borderPaid],
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            radius: '95%',
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const v = Number(context.parsed || 0);
                            return `${context.label}: ${v.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
                        }
                    }
                }
            }
        }
    });

    // Stock pie (same style as crypto)
    const stockSumNow = (Array.isArray(stockNowData) ? stockNowData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const stockSumPaid = (Array.isArray(stockPaidData) ? stockPaidData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);

    const stockSumNowEl = document.getElementById('stockSumNowText');
    const stockSumPaidEl = document.getElementById('stockSumPaidText');
    if (stockSumNowEl) stockSumNowEl.textContent = formatMoney(stockSumNow);
    if (stockSumPaidEl) stockSumPaidEl.textContent = formatMoney(stockSumPaid);

    const stockCanvas = document.getElementById('stockChart');
    if (stockCanvas) {
        new Chart(stockCanvas, {
            type: 'pie',
            data: {
                labels,
                datasets: [
                    {
                        label: `Stock Portfolio (${baseCurrency})`,
                        data: [stockSumNow, stockSumPaid],
                        backgroundColor: [colorNow, colorPaid],
                        borderColor: [borderNow, borderPaid],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                radius: '95%',
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const v = Number(context.parsed || 0);
                                return `${context.label}: ${v.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

{% else %}
<script>
    window.location.replace('/login');
</script>
 <div style="width: 100%; max-width: 720px; margin: 40px auto; padding: 0 16px;">
    <div class="totals-card" style="padding: 18px 18px 16px;">
        <div class="crypto-page-title" style="margin: 0 0 6px 0; text-align: center;">Welcome</div>
        <div class="small-muted" style="text-align: center; margin-bottom: 12px;">
            Sign in to access your wallets, track crypto & stock holdings, and manage daily transactions.
        </div>
        <!-- <div class="small-muted" style="text-align: center; margin-bottom: 10px;">
             Please sign in to see your wallets. 
        </div> --->

        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <a class="btn-cancel" href="/login" style="text-decoration: none;">Sign in / Create account</a>
            <!-- <a class="btn-insert" href="/login" style="text-decoration: none;">Create account / sign up</a> -->
        </div>

        <div class="small-muted" style="text-align: center; margin-top: 12px;">
            <!-- New here? You can create an account during sign-in.
            <span style="opacity: 0.7;">·</span> -->
            You’ll be redirected to our secure sign-in provider.
        </div>
    </div>
</div> 
{% endif %}
{% endblock %}
