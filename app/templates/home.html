{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}
<!-- <h1>Home</h1> -->
{% if session.get('user') %}
<!-- <h6>Username : {{ userId }}</h6> -->


<style>
    .grid-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 20px;
        height: auto;
        align-items: stretch;
    }
    .grid-item {
        display: flex;
        align-items: stretch;
        justify-content: stretch;
        min-height: 250px; 
    }

    .home-card {
        width: 100%;
        height: 100%;
        min-height: 320px;
    }
    #myChart {
        width: 100% !important;
        height: 100% !important;
    }

    @media (max-width: 768px) {
        .grid-container {
            grid-template-columns: 1fr; 
        }
    }

    .loan-pies {
        display: block;
    }
    #loanBarChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    @media (max-width: 768px) {
        /* keep bar chart full-width */
    }
</style>

<div class="grid-container">
    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Wallet Balances</div>
            {% if wallets and wallets|length > 0 %}
                <div style="flex: 1 1 auto; min-height: 200px;">
                    <canvas id="walletChart"></canvas>
                </div>
            {% else %}
                <div class="small-muted" style="text-align: center; padding: 10px 0;">No wallets found</div>
            {% endif %}
        </div>
    </div>

    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Crypto Portfolio</div>
            <div style="flex: 1 1 auto; display: flex; align-items: center; justify-content: center;">
                <div style="width: 100%; max-width: 440px; height: 260px;">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div class="totals-meta" style="margin-top: 10px;">
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value now</div>
                    <div class="totals-value"><span class="pct-positive" id="sumNowText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value paid</div>
                    <div class="totals-value"><span class="pct-negative" id="sumPaidText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Gain / loss</div>
                    <div class="totals-value">
                        <span class="{% if cryptoPortfolioGainIsPositive %}pct-positive{% else %}pct-negative{% endif %}">
                            {% if cryptoPortfolioGainIsPositive %}+{% else %}-{% endif %}{{ cryptoPortfolioGainAbsDisplay }} {{ baseCurrency }}
                        </span>
                        <span class="small-muted">
                            {% if cryptoPortfolioGainPctDisplay and cryptoPortfolioGainPctDisplay != 'N/A' %}
                                ({{ cryptoPortfolioGainPctDisplay }})
                            {% else %}
                                (N/A)
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Stock Portfolio</div>
            <div style="flex: 1 1 auto; display: flex; align-items: center; justify-content: center;">
                <div style="width: 100%; max-width: 440px; height: 260px;">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
            <div class="totals-meta" style="margin-top: 10px;">
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value now</div>
                    <div class="totals-value"><span class="pct-positive" id="stockSumNowText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Total value paid</div>
                    <div class="totals-value"><span class="pct-negative" id="stockSumPaidText"></span></div>
                </div>
                <div class="totals-row">
                    <div class="totals-label small-muted">Gain / loss</div>
                    <div class="totals-value">
                        <span class="{% if stockPortfolioGainIsPositive %}pct-positive{% else %}pct-negative{% endif %}">
                            {% if stockPortfolioGainIsPositive %}+{% else %}-{% endif %}{{ stockPortfolioGainAbsDisplay|default('0') }} {{ baseCurrency }}
                        </span>
                        <span class="small-muted">
                            {% if stockPortfolioGainPctDisplay and stockPortfolioGainPctDisplay != 'N/A' %}
                                ({{ stockPortfolioGainPctDisplay }})
                            {% else %}
                                (N/A)
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="grid-item">
        <div class="totals-card home-card" style="display: flex; flex-direction: column;">
            <div class="crypto-page-title" style="text-align: center; margin: 0 0 6px 0;">Debts & Loans</div>
            {% if loanHomePositions and loanHomePositions|length > 0 %}
                <div class="loan-pies" style="flex: 1 1 auto; min-height: 260px;">
                    <canvas id="loanBarChart"></canvas>
                </div>
            {% else %}
                <div class="small-muted" style="text-align: center; padding: 10px 0;">No open loan positions</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Wallet balances chart
    const walletItems = [
        {% if wallets and wallets|length > 0 %}
            {% for wallet in wallets %}
                {
                    name: {{ (wallet.walletName or wallet.walletId or '') | tojson }},
                    type: {{ (wallet.walletType or '') | tojson }},
                    currency: {{ (wallet.currency or '') | tojson }},
                    balance: {{ (wallet.balance or 0) | tojson }},
                    balanceBase: {{ (wallet.balanceBase or 0) | tojson }},
                    balanceWallet: {{ (wallet.balanceWallet or 0) | tojson }},
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        {% endif %}
    ];

    // Sort wallets by name (asc).
    if (Array.isArray(walletItems)) {
        walletItems.sort((a, b) => {
            const an = String(a?.name || '');
            const bn = String(b?.name || '');
            return an.localeCompare(bn);
        });
    }

    // Label format: "WalletName (CUR)".
    const walletLabels = (walletItems || []).map(w => {
        const name = String(w?.name || '').trim();
        const cur = String(w?.currency || '').trim();
        return cur ? `${name} (${cur})` : name;
    });
    // Bars are in base/setting currency.
    const walletBalances = (walletItems || []).map(w => Number(w?.balanceBase ?? w?.balance) || 0);

    const nowData = {{ cryptoNowValues | tojson }};
    const paidData = {{ cryptoPaidValues | tojson }};
    const stockNowData = {{ (stockNowValues or []) | tojson }};
    const stockPaidData = {{ (stockPaidValues or []) | tojson }};
    const baseCurrency = {{ (baseCurrency or 'EUR') | tojson }};
    const loanHomePositions = {{ (loanHomePositions or []) | tojson }};
    const gainIsPositive = {{ (cryptoPortfolioGainIsPositive or false) | tojson }};
    const gainAbsDisplay = {{ (cryptoPortfolioGainAbsDisplay or '0') | tojson }};
    const gainPctDisplay = {{ (cryptoPortfolioGainPctDisplay or 'N/A') | tojson }};

    // Sum totals across all cryptos (overall portfolio)
    const sumNow = (Array.isArray(nowData) ? nowData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const sumPaid = (Array.isArray(paidData) ? paidData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const labels = ['Total Value Now', 'Total Value Paid'];

    const formatMoney = (v) => {
        const n = Number(v || 0);
        return `${n.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
    };

    // Fill below-chart totals
    const sumNowEl = document.getElementById('sumNowText');
    const sumPaidEl = document.getElementById('sumPaidText');
    if (sumNowEl) sumNowEl.textContent = formatMoney(sumNow);
    if (sumPaidEl) sumPaidEl.textContent = formatMoney(sumPaid);

    // Green for "Now", Red for "Paid"
    // Slightly muted ("matte") colors aligned with the app's green/red.
    const colorNow = 'rgba(76, 180, 100, 0.45)';
    const colorPaid = 'rgba(240, 87, 87, 0.45)';
    const borderNow = 'rgba(76, 180, 100, 0.9)';
    const borderPaid = 'rgba(240, 87, 87, 0.9)';

    const cssVar = (name) => {
        try {
            return (getComputedStyle(document.documentElement).getPropertyValue(name) || '').trim();
        } catch (_e) {
            return '';
        }
    };

    const hexToRgba = (hex, alpha) => {
        const raw = String(hex || '').trim().replace('#', '');
        const isShort = raw.length === 3;
        const isLong = raw.length === 6;
        if (!isShort && !isLong) return null;
        const r = parseInt(isShort ? raw[0] + raw[0] : raw.slice(0, 2), 16);
        const g = parseInt(isShort ? raw[1] + raw[1] : raw.slice(2, 4), 16);
        const b = parseInt(isShort ? raw[2] + raw[2] : raw.slice(4, 6), 16);
        if ([r, g, b].some(n => Number.isNaN(n))) return null;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    };

    // Type colors (reuse existing theme/bootstrap variables)
    const bsPrimary = cssVar('--bs-primary');
    const titleAccentHex = cssVar('--title-accent') || '#6c757d';
    const lendHex = bsPrimary || titleAccentHex;
    const lendOutstandingColor = hexToRgba(lendHex, 0.35) || colorPaid;
    const lendOutstandingBorder = hexToRgba(lendHex, 0.9) || borderPaid;
    const loanOutstandingColor = hexToRgba(titleAccentHex, 0.35) || colorPaid;
    const loanOutstandingBorder = hexToRgba(titleAccentHex, 0.9) || borderPaid;

    // Pie start angle: put the dividing line at 12 o'clock.
    // Chart.js uses radians for rotation.
    const pieTopRotation = -0.5 * Math.PI;

    // Loans: small progress pies (one per open position)
    if (Array.isArray(loanHomePositions) && loanHomePositions.length > 0) {
        const loanCanvas = document.getElementById('loanBarChart');
        if (loanCanvas) {
            const loanMeta = loanHomePositions.map((p) => {
                const principal = Number(p?.principal || 0);
                const repaid = Number(p?.repaid || 0);
                const outstanding = Number(p?.outstanding || 0);
                const ccy = String(p?.currency || '').trim();
                const name = String(p?.counterparty || '—').trim() || '—';
                const typeLabel = String(p?.typeLabel || 'Loan').trim() || 'Loan';

                const repaidVal = Math.max(0, Math.min(repaid, principal || repaid));
                const remainingVal = Math.max(0, outstanding);
                const total = principal > 0 ? principal : (repaidVal + remainingVal);
                const repaidPct = total > 0 ? (repaidVal / total) * 100 : 0;
                const remainingPct = Math.max(0, 100 - repaidPct);

                const fmt = (v) => Number(v || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
                const totalText = `${fmt(total)}${ccy ? ' ' + ccy : ''}`;
                const displayLabel = name;

                return {
                    label: [displayLabel, totalText],
                    displayLabel,
                    totalText,
                    typeLabel,
                    ccy,
                    repaidVal,
                    remainingVal,
                    repaidPct,
                    remainingPct,
                };
            });

            const loanLabels = loanMeta.map(x => x.label);
            const repaidPctData = loanMeta.map(x => x.repaidPct);

            const typeKey = (m) => String(m?.typeLabel || '').trim().toLowerCase();
            const isBorrow = (m) => typeKey(m).includes('borrow');
            const isLend = (m) => typeKey(m).includes('lend');
            const isLoan = (m) => typeKey(m).includes('loan');

            const remainingBorrowPctData = loanMeta.map(m => (isBorrow(m) ? m.remainingPct : 0));
            const remainingLendPctData = loanMeta.map(m => (isLend(m) ? m.remainingPct : 0));
            const remainingLoanPctData = loanMeta.map(m => (isLoan(m) ? m.remainingPct : 0));

            const segmentRadius = (ctx) => {
                const v = Number(ctx?.raw || 0);
                if (!(v > 0)) return 0;

                const chart = ctx?.chart;
                const dataIndex = ctx?.dataIndex;
                const datasetIndex = ctx?.datasetIndex;
                const ds = chart?.data?.datasets || [];

                const vals = ds.map(d => Number(d?.data?.[dataIndex] || 0));
                const nonZero = vals
                    .map((val, idx) => ({ val, idx }))
                    .filter(x => x.val > 0);
                if (nonZero.length <= 1) return 6;

                const firstIdx = nonZero[0].idx;
                const lastIdx = nonZero[nonZero.length - 1].idx;

                const left = datasetIndex === firstIdx;
                const right = datasetIndex === lastIdx;

                if (left && right) return 6;
                return {
                    topLeft: left ? 6 : 0,
                    bottomLeft: left ? 6 : 0,
                    topRight: right ? 6 : 0,
                    bottomRight: right ? 6 : 0,
                };
            };

            new Chart(loanCanvas, {
                type: 'bar',
                data: {
                    labels: loanLabels,
                    datasets: [
                        {
                            label: 'Repaid',
                            data: repaidPctData,
                            backgroundColor: colorNow,
                            borderColor: borderNow,
                            borderWidth: 0,
                            borderRadius: segmentRadius,
                            borderSkipped: false,
                            barThickness: 14,
                        },
                        {
                            label: 'Borrow',
                            data: remainingBorrowPctData,
                            backgroundColor: colorPaid,
                            borderColor: borderPaid,
                            borderWidth: 0,
                            borderRadius: segmentRadius,
                            borderSkipped: false,
                            barThickness: 14,
                        },
                        {
                            label: 'Lend',
                            data: remainingLendPctData,
                            backgroundColor: lendOutstandingColor,
                            borderColor: lendOutstandingBorder,
                            borderWidth: 0,
                            borderRadius: segmentRadius,
                            borderSkipped: false,
                            barThickness: 14,
                        },
                        {
                            label: 'Loan',
                            data: remainingLoanPctData,
                            backgroundColor: loanOutstandingColor,
                            borderColor: loanOutstandingBorder,
                            borderWidth: 0,
                            borderRadius: segmentRadius,
                            borderSkipped: false,
                            barThickness: 14,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    interaction: { mode: 'index', axis: 'y', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 40,
                                boxHeight: 10,
                            }
                        },
                        tooltip: {
                            filter: function(context) {
                                const v = Number(context?.parsed?.x ?? 0);
                                return v > 0;
                            },
                            callbacks: {
                                title: function(context) {
                                    const idx = context && context[0] ? context[0].dataIndex : 0;
                                    const m = loanMeta[idx] || {};
                                    return `${m.displayLabel || ''} - ${m.typeLabel || ''}`.trim();
                                },
                                label: function(context) {
                                    const idx = context?.dataIndex ?? 0;
                                    const m = loanMeta[idx] || {};
                                    const repaidPct = Number(m.repaidPct || 0);
                                    const remainingPct = Number(m.remainingPct || 0);
                                    const repaidAmt = Number(m.repaidVal || 0);
                                    const remainingAmt = Number(m.remainingVal || 0);
                                    const ccy = m.ccy ? ' ' + m.ccy : '';
                                    const repaidText = repaidAmt.toLocaleString(undefined, { maximumFractionDigits: 2 });
                                    const remainingText = remainingAmt.toLocaleString(undefined, { maximumFractionDigits: 2 });

                                    const dsLabel = String(context?.dataset?.label || '').trim();
                                    const pct = Number(context?.parsed?.x ?? 0);
                                    const isRepaid = dsLabel === 'Repaid';
                                    const amtText = isRepaid ? repaidText : remainingText;
                                    const pctText = (isRepaid ? repaidPct : remainingPct).toLocaleString(undefined, { maximumFractionDigits: 0 });
                                    const label = isRepaid ? 'Repaid' : dsLabel;
                                    return `${label}: ${pctText}% (${amtText}${ccy})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return `${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}%`;
                                }
                            },
                            grid: { display: true }
                        },
                        y: {
                            stacked: true,
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    }

    // Render wallet bar chart (if the canvas exists)
    const walletCanvas = document.getElementById('walletChart');
    if (walletCanvas && Array.isArray(walletLabels) && walletLabels.length > 0) {
        const walletColors = walletBalances.map(v => (Number(v) || 0) >= 0 ? colorNow : colorPaid);
        const walletBorderColors = walletBalances.map(v => (Number(v) || 0) >= 0 ? borderNow : borderPaid);

        new Chart(walletCanvas, {
            type: 'bar',
            data: {
                labels: walletLabels,
                datasets: [
                    {
                        label: 'Balance',
                        data: walletBalances,
                        backgroundColor: walletColors,
                        borderColor: walletBorderColors,
                        borderWidth: 1,
                        borderRadius: 6,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const idx = context && context[0] ? context[0].dataIndex : 0;
                                const w = (walletItems && walletItems[idx]) ? walletItems[idx] : {};
                                const name = String(w?.name || '').trim();
                                const type = String(w?.type || '').trim();
                                const cur = String(w?.currency || '').trim();
                                const bits = [name];
                                if (type) bits.push(type);
                                if (cur) bits.push(cur);
                                return bits.filter(Boolean).join(' - ');
                            },
                            label: function(context) {
                                const idx = context?.dataIndex ?? 0;
                                const w = (walletItems && walletItems[idx]) ? walletItems[idx] : {};

                                const vBase = Number(context.parsed.x || 0);
                                const vWallet = Number(w?.balanceWallet || 0);
                                const cur = String(w?.currency || '').trim();
                                const base = String(baseCurrency || '').trim();

                                const curUpper = cur ? cur.toUpperCase() : '';
                                const baseUpper = base ? base.toUpperCase() : '';

                                const a = base
                                    ? `${vBase.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${base}`
                                    : `${vBase.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
                                const b = cur
                                    ? `${vWallet.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${cur}`
                                    : `${vWallet.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

                                // If currencies are the same, show a single value (no repetition).
                                if (curUpper && baseUpper && curUpper === baseUpper) {
                                    return a;
                                }

                                // If one side is missing currency, fall back to showing the other.
                                if (baseUpper && !curUpper) return a;
                                if (!baseUpper && curUpper) return b;

                                return `${a} - ${b}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value) {
                                return `${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
                            }
                        },
                        grid: { display: true }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    new Chart(document.getElementById('myChart'), {
        type: 'pie',
        data: {
            labels,
            datasets: [
                {
                    label: `Crypto Portfolio (${baseCurrency})`,
                    data: [sumNow, sumPaid],
                    backgroundColor: [colorNow, colorPaid],
                    borderColor: [borderNow, borderPaid],
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            radius: '95%',
            rotation: pieTopRotation,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const v = Number(context.parsed || 0);
                            return `${context.label}: ${v.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
                        }
                    }
                }
            }
        }
    });

    // Stock pie (same style as crypto)
    const stockSumNow = (Array.isArray(stockNowData) ? stockNowData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);
    const stockSumPaid = (Array.isArray(stockPaidData) ? stockPaidData : []).reduce((acc, v) => acc + (Number(v) || 0), 0);

    const stockSumNowEl = document.getElementById('stockSumNowText');
    const stockSumPaidEl = document.getElementById('stockSumPaidText');
    if (stockSumNowEl) stockSumNowEl.textContent = formatMoney(stockSumNow);
    if (stockSumPaidEl) stockSumPaidEl.textContent = formatMoney(stockSumPaid);

    const stockCanvas = document.getElementById('stockChart');
    if (stockCanvas) {
        new Chart(stockCanvas, {
            type: 'pie',
            data: {
                labels,
                datasets: [
                    {
                        label: `Stock Portfolio (${baseCurrency})`,
                        data: [stockSumNow, stockSumPaid],
                        backgroundColor: [colorNow, colorPaid],
                        borderColor: [borderNow, borderPaid],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                radius: '95%',
                rotation: pieTopRotation,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const v = Number(context.parsed || 0);
                                return `${context.label}: ${v.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${baseCurrency}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

{% else %}
<script>
    window.location.replace('/login');
</script>
 <div style="width: 100%; max-width: 720px; margin: 40px auto; padding: 0 16px;">
    <div class="totals-card" style="padding: 18px 18px 16px;">
        <div class="crypto-page-title" style="margin: 0 0 6px 0; text-align: center;">Welcome</div>
        <div class="small-muted" style="text-align: center; margin-bottom: 12px;">
            Sign in to access your wallets, track crypto & stock holdings, and manage daily transactions.
        </div>
        <!-- <div class="small-muted" style="text-align: center; margin-bottom: 10px;">
             Please sign in to see your wallets. 
        </div> --->

        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <a class="btn-cancel" href="/login" style="text-decoration: none;">Sign in / Create account</a>
            <!-- <a class="btn-insert" href="/login" style="text-decoration: none;">Create account / sign up</a> -->
        </div>

        <div class="small-muted" style="text-align: center; margin-top: 12px;">
            <!-- New here? You can create an account during sign-in.
            <span style="opacity: 0.7;">·</span> -->
            You’ll be redirected to our secure sign-in provider.
        </div>
    </div>
</div> 
{% endif %}
{% endblock %}
