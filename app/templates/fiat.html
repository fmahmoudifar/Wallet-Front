{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}

<script>
    function syncTransTypeUI(prefix) {
        const typeSel = document.getElementById(prefix ? `${prefix}TransType` : 'transType');
        const catRow = document.getElementById(prefix ? `${prefix}MainCatRow` : 'createMainCatRow');
        const catSel = document.getElementById(prefix ? `${prefix}MainCat` : 'mainCat');
        const fromRow = document.getElementById(prefix ? `${prefix}FromWalletRow` : 'createFromWalletRow');
        const toRow = document.getElementById(prefix ? `${prefix}ToWalletRow` : 'createToWalletRow');
        const fromSel = document.getElementById(prefix ? `${prefix}FromWallet` : 'fromWallet');
        const toSel = document.getElementById(prefix ? `${prefix}ToWallet` : 'toWallet');
        const feeRow = document.getElementById(prefix ? `${prefix}FeeRow` : 'createFeeRow');
        const feeEl = document.getElementById(prefix ? `${prefix}Fee` : 'fee');

        if (!typeSel) return;
        const t = (typeSel.value || '').toLowerCase();

        const showFrom = (t === 'expense' || t === 'transfer');
        const showTo = (t === 'income' || t === 'transfer');
        const showFee = (t === 'transfer');
        const showCat = (t === 'income' || t === 'expense');

        const incomeCats = [
            'Salary, Wage',
            'Savings',
            'Debt',
            'Gift',
            'Interest, Dividends',
            'Lend, Rent',
            'Lottery, Gambling',
            'Refund',
            'Sales',
            'Other',
        ];

        const expenseCats = [
            'Food and Beverage',
            'Purchases',
            'Housing',
            'Transportation',
            'Vehicle',
            'Entertainment',
            'Communications',
            'Financial Expenses',
            'Investments',
            'Loans',
            'Other',
        ];

        function rebuildCategoryOptions(options) {
            if (!catSel) return;

            const currentVal = String(catSel.value || '').trim();
            catSel.innerHTML = '';

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = '-- Select --';
            catSel.appendChild(placeholder);

            (options || []).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                catSel.appendChild(opt);
            });

            if (currentVal) {
                const has = Array.from(catSel.options || []).some(o => String(o.value) === String(currentVal));
                if (!has) {
                    const opt = document.createElement('option');
                    opt.value = currentVal;
                    opt.textContent = currentVal;
                    catSel.appendChild(opt);
                }
                catSel.value = currentVal;
            }
        }

        if (fromRow) fromRow.style.display = showFrom ? '' : 'none';
        if (toRow) toRow.style.display = showTo ? '' : 'none';
        if (feeRow) feeRow.style.display = showFee ? '' : 'none';
        if (catRow) catRow.style.display = showCat ? '' : 'none';

        if (fromSel) fromSel.required = (t === 'expense' || t === 'transfer');
        if (toSel) toSel.required = (t === 'income' || t === 'transfer');

        if (catSel) {
            if (t === 'income') rebuildCategoryOptions(incomeCats);
            else if (t === 'expense') rebuildCategoryOptions(expenseCats);

            catSel.required = (t === 'income' || t === 'expense');
        }

        // Clear hidden fields so users don't accidentally submit stale values.
        if (!showFrom && fromSel) fromSel.value = '';
        if (!showTo && toSel) toSel.value = '';
        if (!showFee && feeEl) feeEl.value = '';
        if (!showCat && catSel) catSel.value = '';

        // Clear any prior custom validity.
        if (fromSel) fromSel.setCustomValidity('');
        if (toSel) toSel.setCustomValidity('');

        // For transfers, require different wallets.
        if (t === 'transfer' && fromSel && toSel) {
            const fromVal = String(fromSel.value || '');
            const toVal = String(toSel.value || '');
            if (fromVal && toVal && fromVal === toVal) {
                toSel.setCustomValidity('From Wallet and To Wallet must be different for transfers.');
            }
        }
    }

    function editTransaction(transId, userId, transType, mainCat, tdate, fromWallet, toWallet, amount, currency, fee, note) {
        document.getElementById("updateTransId").value = transId;
        document.getElementById("updateUserId").value = userId;
        {
            const sel = document.getElementById("updateTransType");
            if (sel) {
                const v = (transType || '').trim();
                const hasOption = Array.from(sel.options || []).some(o => String(o.value) === String(v));
                if (!hasOption && v) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    sel.appendChild(opt);
                }
                sel.value = v;
            }
        }
        syncTransTypeUI('update');
        {
            const sel = document.getElementById("updateMainCat");
            if (sel) {
                const v = (mainCat || '').trim();
                const hasOption = Array.from(sel.options || []).some(o => String(o.value) === String(v));
                if (!hasOption && v) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    sel.appendChild(opt);
                }
                sel.value = v;
            }
        }
        {
            const el = document.getElementById("updateTdate");
            if (el && el._flatpickr) {
                el._flatpickr.setDate(tdate, false, "Y-m-d\\TH:i");
            } else if (el) {
                el.value = tdate;
            }
        }
        document.getElementById("updateAmount").value = amount;
        {
            const sel = document.getElementById("updateFromWallet");
            if (sel) {
                const v = (fromWallet || '').trim();
                const hasOption = Array.from(sel.options || []).some(o => String(o.value) === String(v));
                if (!hasOption && v) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    sel.appendChild(opt);
                }
                sel.value = v;
            }
        }
        {
            const sel = document.getElementById("updateToWallet");
            if (sel) {
                const v = (toWallet || '').trim();
                const hasOption = Array.from(sel.options || []).some(o => String(o.value) === String(v));
                if (!hasOption && v) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    sel.appendChild(opt);
                }
                sel.value = v;
            }
        }
        {
            const sel = document.getElementById("updateCurrency");
            if (sel) {
                const v = (currency || '').trim();
                const hasOption = Array.from(sel.options || []).some(o => String(o.value) === String(v));
                if (!hasOption && v) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    sel.appendChild(opt);
                }
                sel.value = v;
            }
        }
        document.getElementById("updateFee").value = fee;
        document.getElementById("updateNote").value = note;
        document.getElementById("updateTransDiv").style.display = "block";
        document.getElementById("transListDiv").style.display = "none";
        const dashDiv = document.getElementById("fiatDashboardDiv");
        if (dashDiv) dashDiv.style.display = "none";
        const newDiv = document.getElementById("newTrans");
        if (newDiv) newDiv.style.display = "none";

        // In update view, keep all nav buttons visible.
        if (typeof setFiatNavVisibility === 'function') {
            setFiatNavVisibility('update');
        }

        const addBtn = document.getElementById("newTransB");
        if (addBtn) addBtn.style.display = "none";
        const historyBtn = document.getElementById("TransHistoryB");
        if (historyBtn) historyBtn.style.display = "none";

        const title = document.getElementById('transPageTitle');
        if (title) title.innerText = 'Update Transaction';
        document.getElementById("deleteForm").action = `/deleteFiat/${transId}/${userId}`;
    }  

    document.addEventListener("DOMContentLoaded", function() {
        // Show dashboard by default
        if (typeof showFiatDashboard === 'function') {
            showFiatDashboard();
        }

        // Type -> wallet field behavior
        const createType = document.getElementById('transType');
        if (createType) {
            createType.addEventListener('change', function () { syncTransTypeUI(''); });
            syncTransTypeUI('');
        }
        const updateType = document.getElementById('updateTransType');
        if (updateType) {
            updateType.addEventListener('change', function () { syncTransTypeUI('update'); });
        }

        const createFrom = document.getElementById('fromWallet');
        const createTo = document.getElementById('toWallet');
        if (createFrom) createFrom.addEventListener('change', function () { syncTransTypeUI(''); });
        if (createTo) createTo.addEventListener('change', function () { syncTransTypeUI(''); });

        const updateFrom = document.getElementById('updateFromWallet');
        const updateTo = document.getElementById('updateToWallet');
        if (updateFrom) updateFrom.addEventListener('change', function () { syncTransTypeUI('update'); });
        if (updateTo) updateTo.addEventListener('change', function () { syncTransTypeUI('update'); });

        const list = document.getElementById("transList");
        if (list) {
            const items = Array.from(list.querySelectorAll('li[data-tdate]'));
            if (items.length > 1) {
                items.sort((a, b) => {
                    let dateA = new Date(a.getAttribute("data-tdate") || 0);
                    let dateB = new Date(b.getAttribute("data-tdate") || 0);
                    return dateB - dateA;
                });
                items.forEach(item => list.appendChild(item));
            }

            if (typeof ensureTransGroupsBuilt === 'function') {
                ensureTransGroupsBuilt(true);
            }
            if (typeof applyTransFilters === 'function') {
                applyTransFilters();
            }
        }

        // Dashboard date filter -> charts
        const ds = document.getElementById('dashStart');
        const de = document.getElementById('dashEnd');
        ['input','change'].forEach(evt => {
            if (ds) ds.addEventListener(evt, function(){ renderFiatDashboard(); });
            if (de) de.addEventListener(evt, function(){ renderFiatDashboard(); });
        });

        // Initialize dashboard default range and render
        if (typeof initFiatDashboardDefaults === 'function') {
            initFiatDashboardDefaults();
        }
        if (typeof renderFiatDashboard === 'function') {
            renderFiatDashboard();
        }

        // Hook up live filtering
        const ids = ['filterStart','filterEnd','filterType','filterCategory','filterNote','filterFromWallet','filterToWallet','filterCurrency'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const evt = (el.tagName === 'SELECT') ? 'change' : 'input';
            el.addEventListener(evt, function () {
                window.transCurrentPage = 1;
                applyTransFilters();
            });
        });
    });

    function newTransDiv() {
        const div = document.getElementById("newTrans");
        const list = document.getElementById("transListDiv");
        const update = document.getElementById("updateTransDiv");
        const dash = document.getElementById("fiatDashboardDiv");
        const title = document.getElementById('transPageTitle');

        const isVisible = !!(div && window.getComputedStyle(div).display !== 'none');
        if (isVisible) {
            showFiatDashboard();
            return;
        }

        div.style.display = "block";
        if (list) list.style.display = "none";
        if (dash) dash.style.display = "none";
        if (update) update.style.display = "none";
        if (title) title.innerText = 'New Transaction';
        setFiatNavVisibility('new');
        syncTransTypeUI('');
    }

    function transHistoryDiv() {
        const div = document.getElementById("transListDiv");
        const newDiv = document.getElementById("newTrans");
        const updateDiv = document.getElementById("updateTransDiv");
        const dash = document.getElementById("fiatDashboardDiv");
        const title = document.getElementById('transPageTitle');

        const isVisible = !!(div && window.getComputedStyle(div).display !== 'none');
        if (isVisible) {
            showFiatDashboard();
            return;
        }

        if (newDiv) newDiv.style.display = "none";
        if (updateDiv) updateDiv.style.display = "none";
        if (dash) dash.style.display = "none";
        if (div) div.style.display = "block";
        if (title) title.innerText = 'Transactions History';
        setFiatNavVisibility('history');
        if (typeof applyTransFilters === 'function') { applyTransFilters(); }
    }

    function showFiatDashboard() {
        const dash = document.getElementById("fiatDashboardDiv");
        const list = document.getElementById("transListDiv");
        const newDiv = document.getElementById("newTrans");
        const updateDiv = document.getElementById("updateTransDiv");
        const title = document.getElementById('transPageTitle');

        if (dash) dash.style.display = "block";
        if (list) list.style.display = "none";
        if (newDiv) newDiv.style.display = "none";
        if (updateDiv) updateDiv.style.display = "none";
        if (title) title.innerText = 'Fiat Dashboard';
        setFiatNavVisibility('dashboard');

        if (typeof initFiatDashboardDefaults === 'function') {
            initFiatDashboardDefaults();
        }
        if (typeof renderFiatDashboard === 'function') {
            renderFiatDashboard();
        }
    }
    window.showFiatDashboard = showFiatDashboard;

    function setFiatNavVisibility(activeView) {
        const newBtn = document.getElementById('newTransB');
        const histBtn = document.getElementById('TransHistoryB');
        const dashBtn = document.getElementById('FiatDashB');

        // Hide only the button for the current view.
        if (newBtn) newBtn.style.display = (activeView === 'new') ? 'none' : '';
        if (histBtn) histBtn.style.display = (activeView === 'history') ? 'none' : '';
        if (dashBtn) dashBtn.style.display = (activeView === 'dashboard') ? 'none' : '';
    }
    window.setFiatNavVisibility = setFiatNavVisibility;

    function initFiatDashboardDefaults() {
        const startEl = document.getElementById('dashStart');
        const endEl = document.getElementById('dashEnd');
        if (!startEl || !endEl) return;

        // Only set defaults if empty
        const hasStart = !!String(startEl.value || '').trim();
        const hasEnd = !!String(endEl.value || '').trim();
        if (hasStart && hasEnd) return;

        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
        const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

        if (startEl._flatpickr) startEl._flatpickr.setDate(start, false, "Y-m-d\\TH:i");
        else startEl.value = formatLocalDateTime(start);

        if (endEl._flatpickr) endEl._flatpickr.setDate(end, false, "Y-m-d\\TH:i");
        else endEl.value = formatLocalDateTime(end);
    }
    window.initFiatDashboardDefaults = initFiatDashboardDefaults;

    function setDashRangeForMonth(year, monthIndex) {
        const startEl = document.getElementById('dashStart');
        const endEl = document.getElementById('dashEnd');
        if (!startEl || !endEl) return;

        const start = new Date(year, monthIndex, 1, 0, 0, 0);
        const end = new Date(year, monthIndex + 1, 0, 23, 59, 59);

        if (startEl._flatpickr) startEl._flatpickr.setDate(start, false, "Y-m-d\\TH:i");
        else startEl.value = formatLocalDateTime(start);

        if (endEl._flatpickr) endEl._flatpickr.setDate(end, false, "Y-m-d\\TH:i");
        else endEl.value = formatLocalDateTime(end);
    }

    function shiftFiatDashboardMonth(delta) {
        const startVal = document.getElementById('dashStart')?.value || '';
        const anchor = parseLocalDateTime(startVal) || new Date();
        const y = anchor.getFullYear();
        const m = anchor.getMonth();
        const target = new Date(y, m + Number(delta || 0), 1, 0, 0, 0);
        setDashRangeForMonth(target.getFullYear(), target.getMonth());
        renderFiatDashboard();
    }
    window.shiftFiatDashboardMonth = shiftFiatDashboardMonth;

    function resetFiatDashboardDates() {
        const startEl = document.getElementById('dashStart');
        const endEl = document.getElementById('dashEnd');
        if (!startEl || !endEl) return;
        startEl.value = '';
        endEl.value = '';
        if (startEl._flatpickr) startEl._flatpickr.clear();
        if (endEl._flatpickr) endEl._flatpickr.clear();
        initFiatDashboardDefaults();
        renderFiatDashboard();
    }
    window.resetFiatDashboardDates = resetFiatDashboardDates;

    function renderFiatDashboard() {
        const list = document.getElementById('transList');
        if (!list) return;

        const startVal = document.getElementById('dashStart')?.value || '';
        const endVal = document.getElementById('dashEnd')?.value || '';
        const startDt = parseLocalDateTime(startVal);
        const endDt = parseLocalDateTime(endVal);

        const items = Array.from(list.querySelectorAll('li[data-tdate]'));
        const incomeByCat = {};
        const expenseByCat = {};
        let incomeTotal = 0;
        let expenseTotal = 0;

        items.forEach(li => {
            const tdate = parseTxDate(li.getAttribute('data-tdate'));
            if ((startDt || endDt) && !tdate) return;
            if (startDt && tdate && tdate < startDt) return;
            if (endDt && tdate && tdate > endDt) return;

            const type = String(li.getAttribute('data-type') || '').trim().toLowerCase();
            if (type !== 'income' && type !== 'expense') return;

            const cat = String(li.getAttribute('data-cat') || '').trim() || 'Other';
            const amount = parseFloat(String(li.getAttribute('data-amount') || '0')) || 0;
            if (!amount) return;

            const bucket = (type === 'income') ? incomeByCat : expenseByCat;
            bucket[cat] = (bucket[cat] || 0) + amount;

            if (type === 'income') incomeTotal += amount;
            else expenseTotal += amount;
        });

        const fmt = (n) => {
            try {
                return Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
            } catch (e) {
                return String(Number(n || 0));
            }
        };

        const incTotalEl = document.getElementById('dashIncomeTotal');
        const expTotalEl = document.getElementById('dashExpenseTotal');
        if (incTotalEl) incTotalEl.textContent = fmt(incomeTotal);
        if (expTotalEl) expTotalEl.textContent = fmt(expenseTotal);

        function toSortedDataset(mapObj) {
            const entries = Object.entries(mapObj || {}).sort((a, b) => (b[1] || 0) - (a[1] || 0));
            return {
                labels: entries.map(e => e[0]),
                values: entries.map(e => Number(e[1] || 0)),
            };
        }

        const income = toSortedDataset(incomeByCat);
        const expense = toSortedDataset(expenseByCat);

        const emptyIncome = document.getElementById('incomeChartEmpty');
        const emptyExpense = document.getElementById('expenseChartEmpty');
        if (emptyIncome) emptyIncome.style.display = income.labels.length ? 'none' : '';
        if (emptyExpense) emptyExpense.style.display = expense.labels.length ? 'none' : '';

        // Charts
        if (window.Chart) {
            if (window.__fiatIncomeChart) { try { window.__fiatIncomeChart.destroy(); } catch(e) {} }
            if (window.__fiatExpenseChart) { try { window.__fiatExpenseChart.destroy(); } catch(e) {} }
            if (window.__fiatIncomeBarChart) { try { window.__fiatIncomeBarChart.destroy(); } catch(e) {} }
            if (window.__fiatExpenseBarChart) { try { window.__fiatExpenseBarChart.destroy(); } catch(e) {} }

            const ic = document.getElementById('incomeChart');
            const ec = document.getElementById('expenseChart');
            const ib = document.getElementById('incomeBarChart');
            const eb = document.getElementById('expenseBarChart');

            if (ic) {
                window.__fiatIncomeChart = new Chart(ic, {
                    type: 'pie',
                    data: {
                        labels: income.labels,
                        datasets: [{
                            label: 'Income',
                            data: income.values,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                        }
                    }
                });
            }
            if (ec) {
                window.__fiatExpenseChart = new Chart(ec, {
                    type: 'pie',
                    data: {
                        labels: expense.labels,
                        datasets: [{
                            label: 'Expense',
                            data: expense.values,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                        }
                    }
                });
            }

            if (ib) {
                window.__fiatIncomeBarChart = new Chart(ib, {
                    type: 'bar',
                    data: {
                        labels: income.labels,
                        datasets: [{
                            label: 'Income',
                            data: income.values,
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }

            if (eb) {
                window.__fiatExpenseBarChart = new Chart(eb, {
                    type: 'bar',
                    data: {
                        labels: expense.labels,
                        datasets: [{
                            label: 'Expense',
                            data: expense.values,
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
        }
    }
    window.renderFiatDashboard = renderFiatDashboard;

    // Utilities for client-side filtering
    function formatLocalDateTime(dt) {
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const d = String(dt.getDate()).padStart(2, '0');
        const hh = String(dt.getHours()).padStart(2, '0');
        const mm = String(dt.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d}T${hh}:${mm}`;
    }

    function parseLocalDateTime(val) {
        if (!val) return null;
        const s = String(val).trim();
        // Parse as local time: YYYY-MM-DDTHH:MM (or with space instead of T)
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2}))?/);
        if (m) {
            const y = Number(m[1]);
            const mo = Number(m[2]) - 1;
            const d = Number(m[3]);
            const hh = Number(m[4] || '0');
            const mm = Number(m[5] || '0');
            const dt = new Date(y, mo, d, hh, mm, 0);
            return isNaN(dt) ? null : dt;
        }

        try {
            const dt = new Date(s);
            return isNaN(dt) ? null : dt;
        } catch(e) {
            return null;
        }
    }

    function parseTxDate(val) {
        if (!val) return null;
        let s = String(val);
        let d = new Date(s);
        if (isNaN(d)) {
            d = new Date(s.replace(' ', 'T'));
        }
        return isNaN(d) ? null : d;
    }

    function monthKeyFromDate(d) {
        if (!d || isNaN(d)) return 'unknown';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
    }

    function monthLabelFromDate(d) {
        if (!d || isNaN(d)) return 'Unknown date';
        try {
            return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
    }

    function buildTransMonthGroups() {
        const list = document.getElementById('transList');
        if (!list) return;

        list.querySelectorAll('li.crypto-group-header').forEach(h => h.remove());

        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        if (!txItems.length) return;

        let currentKey = null;
        txItems.forEach(li => {
            const d = parseTxDate(li.getAttribute('data-tdate'));
            const key = monthKeyFromDate(d);
            li.setAttribute('data-group', key);

            if (key !== currentKey) {
                const header = document.createElement('li');
                header.className = 'crypto-group-header';
                header.setAttribute('data-group', key);
                header.textContent = monthLabelFromDate(d);
                list.insertBefore(header, li);
                currentKey = key;
            }
        });
    }

    function syncTransGroupHeaders() {
        const list = document.getElementById('transList');
        if (!list) return;

        const headers = Array.from(list.querySelectorAll('li.crypto-group-header'));
        if (!headers.length) return;

        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        headers.forEach(h => {
            const key = h.getAttribute('data-group') || '';
            const anyVisible = txItems.some(li => {
                if ((li.getAttribute('data-group') || '') !== key) return false;
                return li.style.display !== 'none';
            });
            h.style.display = anyVisible ? '' : 'none';
        });
    }

    function ensureTransGroupsBuilt(force) {
        const list = document.getElementById('transList');
        if (!list) return;
        const hasHeaders = !!list.querySelector('li.crypto-group-header');
        if (force || !hasHeaders) {
            buildTransMonthGroups();
        }
        syncTransGroupHeaders();
    }

    function applyTransFilters() {
        const list = document.getElementById('transList');
        if (!list) return;

        ensureTransGroupsBuilt(false);
        const items = Array.from(list.querySelectorAll('li[data-tdate]'));

        const startVal = document.getElementById('filterStart')?.value || '';
        const endVal = document.getElementById('filterEnd')?.value || '';
        const typeVal = (document.getElementById('filterType')?.value || '').trim().toLowerCase();
        const catVal = (document.getElementById('filterCategory')?.value || '').trim().toLowerCase();
        const noteVal = (document.getElementById('filterNote')?.value || '').trim().toLowerCase();
        const fromVal = (document.getElementById('filterFromWallet')?.value || '').trim().toLowerCase();
        const toVal = (document.getElementById('filterToWallet')?.value || '').trim().toLowerCase();
        const ccyVal = (document.getElementById('filterCurrency')?.value || '').trim().toLowerCase();

        const startDt = parseLocalDateTime(startVal);
        const endDt = parseLocalDateTime(endVal);

        if (window.transPageSize == null) window.transPageSize = 20;
        if (window.transCurrentPage == null) window.transCurrentPage = 1;

        function itemMatches(li) {
            let show = true;
            const tdate = parseTxDate(li.getAttribute('data-tdate'));
            if (startDt && tdate && tdate < startDt) show = false;
            if (endDt && tdate && tdate > endDt) show = false;
            if ((startDt || endDt) && !tdate) show = false;

            if (show && typeVal) {
                const v = (li.getAttribute('data-type') || '').toLowerCase();
                if (!v.includes(typeVal)) show = false;
            }
            if (show && catVal) {
                const v = (li.getAttribute('data-cat') || '').toLowerCase();
                if (!v.includes(catVal)) show = false;
            }
            if (show && noteVal) {
                const v = (li.getAttribute('data-note') || '').toLowerCase();
                if (!v.includes(noteVal)) show = false;
            }
            if (show && fromVal) {
                const v = (li.getAttribute('data-from') || '').toLowerCase();
                if (!v.includes(fromVal)) show = false;
            }
            if (show && toVal) {
                const v = (li.getAttribute('data-to') || '').toLowerCase();
                if (!v.includes(toVal)) show = false;
            }
            if (show && ccyVal) {
                const v = (li.getAttribute('data-currency') || '').toLowerCase();
                if (!v.includes(ccyVal)) show = false;
            }
            return show;
        }

        const matching = items.filter(itemMatches);
        const total = matching.length;
        const pageSize = Number(window.transPageSize) || 20;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        window.transCurrentPage = Math.min(Math.max(1, Number(window.transCurrentPage) || 1), totalPages);

        items.forEach(li => { li.style.display = 'none'; });
        const startIdx = (window.transCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        matching.slice(startIdx, endIdx).forEach(li => { li.style.display = ''; });

        syncTransGroupHeaders();

        const emptyMsg = document.getElementById('filterEmptyMsg');
        if (emptyMsg) emptyMsg.style.display = total ? 'none' : '';

        const pager = document.getElementById('transPagination');
        const pageInfo = document.getElementById('transPageInfo');
        const prevBtn = document.getElementById('transPrevPage');
        const nextBtn = document.getElementById('transNextPage');
        if (pager) pager.style.display = total ? '' : 'none';
        if (pageInfo) pageInfo.textContent = `Page ${window.transCurrentPage} of ${totalPages}`;
        if (prevBtn) prevBtn.disabled = window.transCurrentPage <= 1;
        if (nextBtn) nextBtn.disabled = window.transCurrentPage >= totalPages;
    }

    function resetTransFilters() {
        ['filterStart','filterEnd','filterType','filterCategory','filterNote','filterFromWallet','filterToWallet','filterCurrency'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            // Flatpickr keeps a separate visible input (altInput). Clearing el.value alone won't update the UI.
            if (el._flatpickr) {
                el._flatpickr.clear();
                return;
            }

            if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            } else {
                el.value = '';
            }
        });
        window.transCurrentPage = 1;
        applyTransFilters();
    }

    function transGoToPrevPage() {
        window.transCurrentPage = Math.max(1, (Number(window.transCurrentPage) || 1) - 1);
        applyTransFilters();
    }

    function transGoToNextPage() {
        window.transCurrentPage = (Number(window.transCurrentPage) || 1) + 1;
        applyTransFilters();
    }
</script>

<div class="crypto-page-header">
    <h1 id="transPageTitle" class="crypto-page-title">Fiat Dashboard</h1>
    <div class="crypto-page-actions">
        <button id="newTransB" class="btn-insert pct-positive" onclick="newTransDiv()">New Transaction</button>
        <button id="TransHistoryB" class="btn-insert" onclick="transHistoryDiv()">Transactions History</button>
        <button id="FiatDashB" class="btn-insert" onclick="showFiatDashboard()">Transaction Dashboard</button>
    </div>
</div>

<div id="fiatDashboardDiv" class="form-container">
    <h2 class="crypto-section-title">Dashboard</h2>
    <div id="dashFilters" class="history-filters">
        <form class="filters-grid" onsubmit="renderFiatDashboard(); return false;">
            <div>
                <button type="button" class="btn-insert" onclick="shiftFiatDashboardMonth(-1)">&lt;&lt;</button>
            </div>
            <div>
                <label for="dashStart">From Date:</label>
                <input type="text" id="dashStart" name="dashStart" data-dt-picker="1">
            </div>
            <div>
                <label for="dashEnd">To Date:</label>
                <input type="text" id="dashEnd" name="dashEnd" data-dt-picker="1">
            </div>
            <div>
                <button type="button" class="btn-insert" onclick="shiftFiatDashboardMonth(1)">&gt;&gt;</button>
            </div>
            <div class="filters-actions">
                <button type="button" class="btn-clear" onclick="resetFiatDashboardDates()">Reset</button>
            </div>
        </form>
    </div>

    <div class="totals-grid fiat-dashboard-grid" style="margin-top:12px;">
        <div class="totals-card fiat-dashboard-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:1rem;font-weight:700">Income by Category</div>
            </div>
            <div id="incomeChartEmpty" class="small-muted" style="display:none;margin:6px 0;">No income in this date range.</div>
            <canvas id="incomeChart" height="320"></canvas>
            <div class="totals-meta" style="margin-top:6px;">
                <div class="totals-row">
                    <div class="totals-label">Total Income</div>
                    <div class="totals-value pct-positive" id="dashIncomeTotal">0</div>
                </div>
            </div>
        </div>
        <div class="totals-card fiat-dashboard-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:1rem;font-weight:700">Expense by Category</div>
            </div>
            <div id="expenseChartEmpty" class="small-muted" style="display:none;margin:6px 0;">No expenses in this date range.</div>
            <canvas id="expenseChart" height="320"></canvas>
            <div class="totals-meta" style="margin-top:6px;">
                <div class="totals-row">
                    <div class="totals-label">Total Expense</div>
                    <div class="totals-value pct-negative" id="dashExpenseTotal">0</div>
                </div>
            </div>
        </div>

        <div class="totals-card fiat-dashboard-bar-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:1rem;font-weight:700">Income (Bar)</div>
            </div>
            <canvas id="incomeBarChart" height="220"></canvas>
        </div>
        <div class="totals-card fiat-dashboard-bar-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:1rem;font-weight:700">Expense (Bar)</div>
            </div>
            <canvas id="expenseBarChart" height="220"></canvas>
        </div>
    </div>
</div>

<div id="newTrans" class="block-new" style="display: none;">
    <h2 class="center-text" style="display:none;">Add New Transaction</h2>
    <div class="form-container">
        <form action="/fiat" method="POST">
    <div>
    <label for="transType">Transaction Type:</label>
    <select id="transType" name="transType" required>
        <option value="">-- Select --</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="Transfer">Transfer</option>
    </select>
    </div>
    <div id="createMainCatRow">
    <label for="mainCat">Category:</label>
    <select id="mainCat" name="mainCat" required>
        <option value="">-- Select --</option>
    </select>
    </div>
    <!-- <input type="text" name="subCat" placeholder="subCat"> -->
    <!-- <input type="datetime-local" name="tdate" placeholder="date"> -->
    <div>
    <label for="tdate">Date:</label>
    <input type="text" id="tdate" name="tdate" data-dt-picker="1" required>
    </div>
    <div>
    <label for="amount">Amount:</label>
    <input type="number" name="amount" step="any" inputmode="decimal" required>
    </div>
    <div id="createFromWalletRow">
    <label for="fromWallet">From Wallet:</label>
    <select name="fromWallet" id="fromWallet">
        <option value="">-- Select Wallet --</option>
        {% for wallet in wallets %}
        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
        {% endfor %}
    </select>
    </div>
    <div id="createToWalletRow">
    <label for="toWallet">To Wallet:</label>
    <select name="toWallet" id="toWallet" required>
        <option value="">-- Select Wallet --</option>
        {% for wallet in wallets %}
        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
        {% endfor %}
    </select>
    </div>
    <div>
    <label for="currency">Currency:</label>
    <select id="currency" name="currency" required>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
    </select>
    </div>
    <div id="createFeeRow">
    <label for="fee">Fee:</label>
    <input type="number" id="fee" name="fee" step="any" inputmode="decimal">
    </div>
    <div>
    <label for="note">Note:</label>
    <input type="text" name="note">
    </div>
                <div>
                    <button type="submit" class="btn-insert pct-positive">Insert</button>
                    <button type="reset" class="btn-clear">Clear</button>
                    <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
                </div>
            </form>
    </div>
</div>

{% if fd %}
    <div class="small-muted" style="margin-bottom:10px">{{ fd }}</div>
{% endif %}

<div id="transListDiv" class="form-container" style="display:none;">
    <h2 class="crypto-section-title">Transactions History</h2>
    <div id="filters" class="history-filters">
        <form class="filters-grid" onsubmit="applyTransFilters(); return false;">
            <div>
                <label for="filterStart">From Date:</label>
                <input type="text" id="filterStart" name="start" data-dt-picker="1">
            </div>
            <div>
                <label for="filterEnd">To Date:</label>
                <input type="text" id="filterEnd" name="end" data-dt-picker="1">
            </div>
            <div>
                <label for="filterType">Type:</label>
                <select id="filterType" name="type">
                    <option value="">-- All --</option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                    <option value="Transfer">Transfer</option>
                </select>
            </div>
            <div>
                <label for="filterCategory">Category:</label>
                <input type="text" id="filterCategory" name="category" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="filterNote">Note:</label>
                <input type="text" id="filterNote" name="note" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="filterFromWallet">From Wallet:</label>
                <select id="filterFromWallet" name="fromWallet">
                    <option value="">-- All --</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filterToWallet">To Wallet:</label>
                <select id="filterToWallet" name="toWallet">
                    <option value="">-- All --</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- <div>
                <label for="filterCurrency">Currency:</label>
                <input type="text" id="filterCurrency" name="currency" placeholder="e.g. EUR" autocomplete="off" />
            </div> -->
            <div class="filters-actions">
                <button type="button" class="btn-clear" onclick="resetTransFilters()">Clear</button>
            </div>
        </form>
        <div id="filterEmptyMsg" class="small-muted" style="display:none;margin-top:8px">No matching transactions.</div>
        <div id="transPagination" class="pagination-controls" style="display:none;margin-top:10px">
            <button id="transPrevPage" type="button" class="btn-clear" onclick="transGoToPrevPage()">Prev</button>
            <div id="transPageInfo" class="small-muted" style="min-width:140px;text-align:center">Page 1 of 1</div>
            <button id="transNextPage" type="button" class="btn-clear" onclick="transGoToNextPage()">Next</button>
        </div>
    </div>
{% if transactions %}
<ul id="transList">
    {% for transaction in transactions %}
        <li data-id="{{ transaction.transId }}" data-tdate="{{ transaction.tdate }}" data-type="{{ transaction.transType|default('') }}" data-cat="{{ transaction.mainCat|default('') }}" data-note="{{ transaction.note|default('') }}" data-from="{{ transaction.fromWallet|default('') }}" data-to="{{ transaction.toWallet|default('') }}" data-currency="{{ transaction.currency|default('') }}" data-amount="{{ transaction.amount|default(0) }}">
            <div class="crypto-history-row">
                <div class="crypto-history-left">
                    <div class="crypto-history-title">{{ transaction.transType }}</div>
                    <div class="crypto-history-sub">{{ transaction.mainCat }}</div>
                    {% if transaction.note %}
                    <div class="crypto-history-sub">{{ transaction.note }}</div>
                    {% endif %}
                </div>

                <div class="crypto-history-right">
                    <div class="crypto-history-amount">{{ transaction.amount }}</div>
                    <div class="crypto-history-sub">{% if transaction.currency %}{{ transaction.currency }}{% endif %}{% if transaction.fee %}{% if transaction.currency %} â€¢ {% endif %}Fee {{ transaction.fee }}{% endif %}</div>
                </div>

                <div class="crypto-history-actions">
                    <button class="btn-insert" onclick="editTransaction('{{ transaction.transId }}','{{ transaction.userId }}','{{ transaction.transType }}','{{ transaction.mainCat }}','{{ transaction.tdate }}','{{ transaction.fromWallet }}','{{ transaction.toWallet }}','{{ transaction.amount }}','{{ transaction.currency }}','{{ transaction.fee }}','{{ transaction.note }}')">Edit</button>
                </div>
            </div>
        </li>
    {% endfor %}
</ul>
</div>

{% else %}
<p>No transactions found.</p>
{% endif %}


<div id="updateTransDiv" class="block-update" style="display: none;">
    <h2 class="center-text" style="display:none;">Update Transaction</h2>
    <div class="form-container">
        <form id="updateForm" action="/updateFiat" method="POST">
            <input type="hidden" id="updateTransId" name="transId">
            <input type="hidden" id="updateUserId" name="userId">
            <div>
                <label>Transaction Type:</label>
                <select id="updateTransType" name="transType" required>
                    <option value="">-- Select --</option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                    <option value="Transfer">Transfer</option>
                </select>
            </div>
            <div id="updateMainCatRow">
                <label>Main Category:</label>
                <select id="updateMainCat" name="mainCat" required>
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div>
                <label>Date:</label>
                <input type="text" id="updateTdate" name="tdate" data-dt-picker="1" required>
            </div>
            <div>
                <label>Amount:</label>
                <input type="number" id="updateAmount" name="amount" step="any" inputmode="decimal" required>
            </div>
            <div id="updateFromWalletRow">
                <label>From Wallet:</label>
                <select id="updateFromWallet" name="fromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="updateToWalletRow">
                <label>To Wallet:</label>
                <select id="updateToWallet" name="toWallet" required>
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Currency:</label>
                <select id="updateCurrency" name="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div id="updateFeeRow">
                <label>Fee:</label>
                <input type="number" id="updateFee" name="fee" step="any" inputmode="decimal">
            </div>
            <div>
                <label>Note:</label>
                <input type="text" id="updateNote" name="note">
            </div>
            <div>
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="submit" form="deleteForm" class="btn-delete" onclick="return confirm('Are you sure?')">Delete</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>

    <form id="deleteForm" method="POST"></form>
</div>

{% endblock %}
