{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}

<script>
    // Persist theme choice client-side so it applies across pages immediately.
    function persistTheme(themeValue) {
        try {
            const t = String(themeValue || '').toLowerCase();
            const theme = t.startsWith('d') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            document.documentElement.setAttribute('data-theme', theme);
        } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', function () {
        const newTheme = document.getElementById('newTheme');
        const updateTheme = document.getElementById('updateTheme');
        if (newTheme) newTheme.addEventListener('change', () => persistTheme(newTheme.value));
        if (updateTheme) updateTheme.addEventListener('change', () => persistTheme(updateTheme.value));

        // If server already has a theme, mirror it to localStorage
        const serverTheme = "{{ (settings|first).theme if (settings|first) else '' }}";
        if (serverTheme) persistTheme(serverTheme);
    });
</script>

<script>
    function editSettings(userId, currency, theme) {
        document.getElementById("updateUserId").value = userId;
        document.getElementById("updateCurrency").value = currency;
        document.getElementById("updateTheme").value = theme;
        persistTheme(theme);
        document.getElementById("updateSetDiv").style.display = "block";
        document.getElementById("setListDiv").style.display = "none";
        document.getElementById("newSetB").style.display = "none";
    }  

function newSetDiv() {
    let div = document.getElementById("newSet");
    let button = document.getElementById("newSetB");

    if (div.style.display === "none" || div.style.display === "") {
        div.style.display = "block";
        document.getElementById("setListDiv").style.display = "none";
        button.style.display = "none" ;
        // button.innerText = "Cancel" ;
    } else {
        div.style.display = "none"; 
        document.getElementById("setListDiv").style.display = "block";
        button.innerText = "Add New Settings" ;
    }
}
</script>

<h1 class="page-title">Settings</h1>
<div id="setListDiv" class="form-container">
{% set setting = settings | first %}
{% if setting %}
    <ul id="transList">
        <li>
            <div class="record-grid">
                <div>
                    <strong>Currency:</strong> {{ setting.currency }}<br>
                </div>
                <div>
                    <strong>Theme:</strong> {{ setting.theme }}<br>
                </div>
                <div></div>
                <div>
                    <button class="btn-insert" onclick="editSettings('{{ setting.userId }}','{{ setting.currency }}','{{ setting.theme }}')">Edit</button>
                </div>
            </div>
        </li>
    </ul>
</div>

{% else %}
<div id="newSet" class="block-new">
    <h2 class="center-text">New Settings</h2>
    <div class="form-container">
        <form action="/updateSettings" method="POST">
            <div>
                <label>Currency:</label>
                <select id="newCurrency" name="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="CHF">CHF</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                    <option value="JPY">JPY</option>
                    <option value="SEK">SEK</option>
                    <option value="NOK">NOK</option>
                    <option value="DKK">DKK</option>
                </select>
            </div>
            <div>
                <label for="theme">Theme:</label>
                <select id="newTheme" name="theme" required>
                    <option value="Light">Light</option>
                    <option value="Dark">Dark</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endif %}


<div id="updateSetDiv" class="block-update" style="display: none;">
    <h2 class="center-text">Update Settings</h2>
    <div class="form-container">
        <form id="updateForm" action="/updateSettings" method="POST">
            <input type="hidden" id="updateSettingId" name="settingId">
            <input type="hidden" id="updateUserId" name="userId">
            <div>
                <label>Currency:</label>
                <select id="updateCurrency" name="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="CHF">CHF</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                    <option value="JPY">JPY</option>
                    <option value="SEK">SEK</option>
                    <option value="NOK">NOK</option>
                    <option value="DKK">DKK</option>
                </select>
            </div>
            <div>
                <label>Theme:</label>
                <select id="updateTheme" name="theme" required>
                    <option value="Light">Light</option>
                    <option value="Dark">Dark</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>

    <form id="deleteForm" method="POST"></form>
</div>

{% endblock %}