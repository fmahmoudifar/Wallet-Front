{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}
{% if session.get('user') %}

<!-- counterparties data provided to JS via data attribute to avoid inline template tags in scripts -->
<div id="counterparties-data" style="display:none" data-counterparties='{{ counterparties|default([])|tojson | safe }}'></div>

<!-- positions catalog provided to JS (explicit Position support) -->
<div id="positions-data" style="display:none" data-positions='{{ positions_catalog|default([])|tojson | safe }}'></div>

<div class="crypto-page-header">
    <h1 id="loansPageTitle" class="crypto-page-title">Borrow &amp; Lend</h1>
</div>

<div class="app-subnav app-subnav-mobile" aria-label="Loans sections">
    <button type="button" class="app-subnav-link" data-loans-nav="portfolio" onclick="showLoansPortfolio()">Overview</button>
    <button type="button" class="app-subnav-link" data-loans-nav="new" onclick="showLoansNew()">New</button>
    <button type="button" class="app-subnav-link" data-loans-nav="history" onclick="showLoansHistory()">History</button>
</div>

<div id="panel" class="panel" style="padding:12px;margin-bottom:12px;">
    <div class="totals-card" style="width:100%;max-width:1100px;">
        <div class="crypto-page-title" style="margin:0 0 6px 0;">Overview</div>
        <div class="small-muted">Track who owes you, what you owe, and due dates.</div>

        <div class="totals-grid" style="margin-top:12px;">
            <div class="totals-card" style="box-shadow:none;">
                <div class="small-muted" style="font-weight:700;">You will receive</div>
                {% if receive_totals and receive_totals|length > 1 %}
                    <div style="margin-top:4px;display:flex;flex-direction:column;gap:2px;">
                        {% for ccy, amt in receive_totals|dictsort %}
                            <div class="totals-value">{{ amt|default(0) }} {{ ccy }}</div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="totals-value" style="margin-top:4px;">{{ receive_total|default(0) }}{% if base_currency %} {{ base_currency }}{% endif %}</div>
                {% endif %}
            </div>
            <div class="totals-card" style="box-shadow:none;">
                <div class="small-muted" style="font-weight:700;">You owe</div>
                {% if owe_totals and owe_totals|length > 1 %}
                    <div style="margin-top:4px;display:flex;flex-direction:column;gap:2px;">
                        {% for ccy, amt in owe_totals|dictsort %}
                            <div class="totals-value">{{ amt|default(0) }} {{ ccy }}</div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="totals-value" style="margin-top:4px;">{{ owe_total|default(0) }}{% if base_currency %} {{ base_currency }}{% endif %}</div>
                {% endif %}
            </div>
        </div>

        {% if loan_positions and loan_positions|length %}
        <div class="crypto-page-title" style="margin:14px 0 6px 0; font-size: 1rem;">By position</div>
        <div class="small-muted">Grouped by position (counterparty, currency, date).</div>

        <div class="totals-grid" style="margin-top:12px;">
            {% for p in loan_positions %}
            <div class="totals-card">
                <div class="totals-header">
                    <div>
                        <div style="font-size:1rem;font-weight:700">{{ p.counterparty|default('—') }}</div>
                        <div class="small-muted">{{ p.currency|default(base_currency|default('EUR')) }}</div>
                    </div>
                    <div class="pct-badge {{ p.badge_class|default('pct-neutral') }}">{{ p.type_label|default('Loan') }}</div>
                </div>

                <div class="totals-meta">
                    {% if p.opened_date %}
                    <div class="totals-row">
                        <span class="totals-label small-muted">Opened:</span>
                        <span class="totals-value">{{ p.opened_date }}</span>
                    </div>
                    {% endif %}

                    <div class="totals-row">
                        <span class="totals-label small-muted">Total amount:</span>
                        <span class="totals-value">{{ p.principal_display|default(p.principal|default(0)) }} {{ p.currency|default(base_currency|default('EUR')) }}</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label small-muted">Repaid:</span>
                        <span class="totals-value">{{ p.repaid_display|default(p.repaid|default(0)) }} {{ p.currency|default(base_currency|default('EUR')) }}</span>
                    </div>
                    <div class="totals-row">
                        <span class="totals-label small-muted">Outstanding:</span>
                        <span class="totals-value" style="font-weight:700">{{ p.outstanding_display|default(p.outstanding|default(0)) }} {{ p.currency|default(base_currency|default('EUR')) }}</span>
                    </div>

                    <div class="totals-row">
                        <span class="totals-label small-muted">Status:</span>
                        <span class="totals-value">{{ p.status|default('—') }}</span>
                    </div>

                    <div class="totals-row">
                        <span class="totals-label small-muted">Progress:</span>
                        <span class="totals-value">{{ p.repaid_pct_display|default(0) }}%</span>
                    </div>
                    <div class="pct-bar" aria-hidden="true">
                        <div class="pct-fill pct-fill-positive" data-fill="{{ p.repaid_pct|default(0) }}"></div>
                    </div>

                    {% if p.next_due %}
                    <div class="totals-row">
                        <span class="totals-label small-muted">Due date:</span>
                        <span class="totals-value">{{ p.next_due }}</span>
                    </div>
                    {% endif %}

                    {% if p.last_activity %}
                    <div class="totals-row">
                        <span class="totals-label small-muted">Last activity:</span>
                        <span class="totals-value">{{ p.last_activity }}</span>
                    </div>
                    {% endif %}

                    <div class="totals-row">
                        <span class="totals-label small-muted">Transactions:</span>
                        <span class="totals-value">{{ p.tx_count|default(0) }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="small-muted" style="margin-top:12px;">No positions yet. Add a new borrow/lend transaction to see a per-counterparty overview.</div>
        {% endif %}
    </div>
</div>

<div id="newLoan" class="block-new" style="display: none;">
    <h2 class="center-text" style="display:none;">Add New Transaction</h2>
    <div class="form-container">
        <form id="createLoanForm" action="/loans" method="POST">
            <div>
                <label for="loansType">Type</label>
                <select id="loansType" name="type" required>
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>

            <div>
                <label for="loansAction">Action</label>
                <select id="loansAction" name="action" required>
                    <option value="new">New</option>
                    <option value="repay">Repay</option>
                </select>
            </div>

            <div>
                <label for="loansCounterparty">Counterparty</label>
                <input id="loansCounterparty" type="text" name="counterparty" placeholder="Name" required>
                <div id="loansCounterpartyList" class="autocomplete-list" style="position:relative"></div>
            </div>

            <div>
                <label for="loansAmount">Amount</label>
                <input id="loansAmount" type="number" name="amount" step="any" inputmode="decimal" placeholder="0" required>
            </div>

            <div>
                <label for="loansCurrency">Currency</label>
                <select id="loansCurrency" name="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="CHF">CHF</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                    <option value="JPY">JPY</option>
                    <option value="SEK">SEK</option>
                    <option value="NOK">NOK</option>
                    <option value="DKK">DKK</option>
                </select>
            </div>

            <div>
                <label for="loansPositionSelect">Position</label>
                <select id="loansPositionSelect">
                    <option value="" selected disabled>-- Select counterparty first --</option>
                    <option value="__new__">New position</option>
                </select>
                <input type="hidden" id="loansPosition" name="position" value="" />
            </div>

            <div id="loansFromWalletRow">
                <label for="fromWallet">From Wallet:</label>
                <select name="fromWallet" id="fromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="loansToWalletRow">
                <label for="toWallet">To Wallet:</label>
                <select name="toWallet" id="toWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="loansDate">Date</label>
                <input id="loansDate" type="text" name="tdate" data-dt-picker="1" placeholder="Select date" required>
            </div>

            <div id="loansDDateRow">
                <label for="loansDDate">Due date (optional)</label>
                <input id="loansDDate" type="text" name="ddate" data-dt-picker="1" placeholder="Select due date">
            </div>

            <div>
                <label for="loansNote">Note</label>
                <input id="loansNote" type="text" name="note" placeholder="Optional">
            </div>

            <div>
                <label for="loansFee">Fee:</label>
                <input id="loansFee" type="number" name="fee" step="any" inputmode="decimal" placeholder="0">
            </div>

            <div>
                <button type="submit" class="btn-insert pct-positive">Insert</button>
                <button type="reset" class="btn-clear">Clear</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="loansListDiv" class="form-container" style="display: none;" >
    <div id="loansFilters" class="history-filters" style="width:100%;max-width:1100px;">
        <form class="filters-grid" onsubmit="applyLoansFilters(); return false;">
            <div>
                <label for="filterStart">From Date:</label>
                <input type="text" id="filterStart" name="start" data-dt-picker="1">
            </div>
            <div>
                <label for="filterEnd">To Date:</label>
                <input type="text" id="filterEnd" name="end" data-dt-picker="1">
            </div>
            <div>
                <label for="filterType">Type:</label>
                <select id="filterType" name="type">
                    <option value="">-- All --</option>
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>
            <div>
                <label for="filterAction">Action:</label>
                <select id="filterAction" name="action">
                    <option value="">-- All --</option>
                    <option value="new">New</option>
                    <option value="repay">Repay</option>
                </select>
            </div>
            <div>
                <label for="filterParty">Counterparty:</label>
                <input type="text" id="filterParty" name="party" placeholder="Contains..." autocomplete="off" />
                <div id="filterPartyList" class="autocomplete-list" style="position:relative"></div>
            </div>
            <div>
                <label for="filterNote">Note:</label>
                <input type="text" id="filterNote" name="note" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="filterFromWallet">From Wallet:</label>
                <select id="filterFromWallet" name="fromWallet">
                    <option value="">-- Any --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filterToWallet">To Wallet:</label>
                <select id="filterToWallet" name="toWallet">
                    <option value="">-- Any --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filters-actions">
                <button type="button" class="btn-clear" onclick="resetLoansFilters()">Clear</button>
            </div>
        </form>
        <div id="filterEmptyMsg" class="small-muted" style="display:none;margin-top:8px">No matching transactions.</div>
        <div id="loansPagination" class="pagination-controls" style="display:none;margin-top:10px">
            <button id="loansPrevPage" type="button" class="btn-clear" onclick="loansGoToPrevPage()">Prev</button>
            <div id="loansPageInfo" class="small-muted" style="min-width:140px;text-align:center">Page 1 of 1</div>
            <button id="loansNextPage" type="button" class="btn-clear" onclick="loansGoToNextPage()">Next</button>
        </div>
    </div>

    {% if loans and loans|length %}
    {% set walletNameById = {} %}
    {% for w in wallets %}
        {% if w['walletId'] is defined %}
            {% set _ = walletNameById.update({ w['walletId']: (w['walletName']|default(w['walletId'])) }) %}
        {% endif %}
    {% endfor %}
    <ul id="loansList">
        {% for tx in loans %}
        {% set _loan_id = (tx.loanId or tx.id)|default('', true) %}
        {% set _uid = tx.userId|default(((session.get('user') or {}).get('username','')), true) %}
        {% set _type_raw = (tx.type|default('borrow', true))|lower %}
        {% set _type = _type_raw %}
        {% set _action_raw = (tx.action|default('', true))|lower %}
        {% set _action = _action_raw if _action_raw else 'new' %}
        {% set _party = tx.counterparty|default('', true) %}
        {% set _note = tx.note|default('', true) %}
        {% set _amount = tx.amount|default('0', true) %}
        {% set _currency = (tx.currency|default((session.get('currency') or 'EUR')|upper, true))|upper %}
        {% set _wallet_id = tx.walletId|default('', true) %}
        {% set _tdate = tx.tdate|default('', true) %}
        {% set _due = tx.ddate|default('', true) %}
        {% set _position = tx.position|default('', true) %}
        {% set _fee = tx.fee|default(0, true) %}
        {% set _from = '' if (tx.fromWallet|default('', true)) == 'None' else (tx.fromWallet|default('', true)) %}
        {% set _to = '' if (tx.toWallet|default('', true)) == 'None' else (tx.toWallet|default('', true)) %}
        <li data-id="{{ _loan_id }}" data-userid="{{ _uid }}" data-tdate="{{ _tdate }}" data-type="{{ _type }}" data-action="{{ _action }}" data-party="{{ _party }}" data-amount="{{ _amount }}" data-currency="{{ _currency }}" data-walletid="{{ _wallet_id }}" data-ddate="{{ _due }}" data-position="{{ _position }}" data-fee="{{ _fee }}" data-note="{{ _note }}" data-from="{{ _from }}" data-to="{{ _to }}">
            <div class="crypto-history-row">
                <div class="crypto-history-left">
                    <div class="crypto-history-title">{{ _party if _party else '—' }}</div>
                    <div class="crypto-history-sub">{{ _type|capitalize }} • {{ _action|capitalize }}</div>
                    {% set fromName = walletNameById.get(_from, _from) %}
                    {% set toName = walletNameById.get(_to, _to) %}
                    {% if fromName or toName %}
                    <div class="crypto-history-sub">{% if fromName and toName %}{{ fromName }} -> {{ toName }}{% else %}{{ fromName or toName }}{% endif %}</div>
                    {% endif %}
                </div>

                <div class="crypto-history-right">
                    <div class="crypto-history-amount">{{ _amount }}{% if _currency %} {{ _currency }}{% endif %}</div>
                    {% if _fee and _fee != 0 and _fee != '0' %}
                    <div class="crypto-history-sub">Fee: {{ _fee }}{% if _currency %} {{ _currency }}{% endif %}</div>
                    {% endif %}
                    {% if _note %}
                    <div class="crypto-history-sub">{{ _note }}</div>
                    {% endif %}
                </div>

                <div class="crypto-history-actions">
                    <button class="btn-insert" type="button" onclick="editLoanFromRow(this)">Edit</button>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="totals-card" style="width:100%;max-width:1100px;">
        <div class="crypto-page-title" style="margin:0 0 6px 0;">Transactions History</div>
        <div class="small-muted">No loan transactions yet.</div>
    </div>
    {% endif %}
</div>

<div id="updateLoanDiv" class="block-update" style="display: none;">
    <h2 class="center-text" style="display:none;">Update Loan Transaction</h2>
    <div class="form-container">
        <form id="updateForm" action="/updateLoan" method="POST">
            <input type="hidden" id="updateLoanId" name="loanId" />
            <input type="hidden" id="updateUserId" name="userId" />
            <input type="hidden" id="updateLockedType" name="type" />
            <input type="hidden" id="updateLockedAction" name="action" />
            <input type="hidden" id="updateLockedCurrency" name="currency" />
            <input type="hidden" id="updateLockedTdate" name="tdate" />

            <div>
                <label for="updateLoansType">Type</label>
                <select id="updateLoansType" name="type_display" required disabled>
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>

            <div>
                <label for="updateLoansAction">Action</label>
                <select id="updateLoansAction" name="action_display" required disabled>
                    <option value="new">New</option>
                    <option value="repay">Repay</option>
                </select>
            </div>

            <div>
                <label for="updateLoansCounterparty">Counterparty</label>
                <input id="updateLoansCounterparty" type="text" name="counterparty" placeholder="Name" required readonly />
                <div id="updateLoansCounterpartyList" class="autocomplete-list" style="position:relative"></div>
            </div>

            <div>
                <label for="updateLoansAmount">Amount</label>
                <input id="updateLoansAmount" type="number" name="amount" step="any" inputmode="decimal" required />
            </div>

            <div>
                <label for="updateLoansCurrency">Currency</label>
                <select id="updateLoansCurrency" name="currency_display" required disabled>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="CHF">CHF</option>
                    <option value="CAD">CAD</option>
                    <option value="AUD">AUD</option>
                    <option value="JPY">JPY</option>
                    <option value="SEK">SEK</option>
                    <option value="NOK">NOK</option>
                    <option value="DKK">DKK</option>
                </select>
            </div>

            <div>
                <label for="updateLoansPositionSelect">Position</label>
                <select id="updateLoansPositionSelect" disabled></select>
                <input type="hidden" id="updateLoansPosition" name="position" value="" />
            </div>

            <div id="updateFromWalletRow">
                <label for="updateFromWallet">From Wallet:</label>
                <select name="fromWallet" id="updateFromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="updateToWalletRow">
                <label for="updateToWallet">To Wallet:</label>
                <select name="toWallet" id="updateToWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="updateLoansDate">Date</label>
                <input id="updateLoansDate" type="text" name="tdate_display" data-dt-picker="1" placeholder="Select date" required disabled />
            </div>

            <div id="updateDDateRow">
                <label for="updateLoansDDate">Due date (optional)</label>
                <input id="updateLoansDDate" type="text" name="ddate" data-dt-picker="1" placeholder="Select due date" />
            </div>

            <div>
                <label for="updateLoansNote">Note</label>
                <input id="updateLoansNote" type="text" name="note" placeholder="Optional" />
            </div>

            <div>
                <label for="updateFee">Fee:</label>
                <input type="number" id="updateFee" name="fee" step="any" inputmode="decimal" placeholder="0">
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="submit" form="deleteForm" class="btn-delete" onclick="return confirm('Are you sure?')">Delete</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>

    <form id="deleteForm" method="POST"></form>
</div>

<script>
    // Counterparty autocomplete (crypto-like UX)
    function initCounterpartyAutocomplete(inputId, listId, names, onCommit) {
        const input = document.getElementById(inputId);
        const listWrap = document.getElementById(listId);
        if (!input || !listWrap) return;
        const itemsSrc = Array.isArray(names) ? names : [];

        let currentFocus = -1;

        function closeAllLists(elmnt) {
            const lists = document.querySelectorAll('.autocomplete-items');
            lists.forEach(l => {
                if (elmnt !== l && elmnt !== input) {
                    try { l.parentNode.removeChild(l); } catch(e) {}
                }
            });
            currentFocus = -1;
        }

        function addActive(items) {
            if (!items || !items.length) return;
            items.forEach(i => { i.classList.remove('autocomplete-active'); i.style.background=''; });
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = items.length - 1;
            items[currentFocus].classList.add('autocomplete-active');
            items[currentFocus].style.background = '#e9e9e9';
        }

        function commit(name) {
            input.value = name || '';
            closeAllLists();
            if (typeof onCommit === 'function') onCommit(name || '');
        }

        input.addEventListener('input', function() {
            const val = String(this.value || '').trim().toLowerCase();
            closeAllLists();
            if (!val) return;

            const matches = itemsSrc
                .filter(n => String(n || '').toLowerCase().includes(val))
                .slice(0, 20);
            if (!matches.length) return;

            const list = document.createElement('div');
            list.setAttribute('class','autocomplete-items');
            if (!listWrap.style.position) listWrap.style.position = 'relative';
            list.style.position = 'absolute';
            list.style.zIndex = 1000;
            list.style.left = '0px';
            list.style.right = '0px';
            list.style.top = '4px';
            list.style.maxHeight = '260px';
            list.style.overflowY = 'auto';
            listWrap.appendChild(list);

            matches.forEach(n => {
                const name = String(n || '').trim();
                if (!name) return;
                const item = document.createElement('div');
                item.textContent = name;
                item.style.padding = '6px 8px';
                item.style.cursor = 'pointer';
                item.addEventListener('mousedown', function() {
                    // Commit before blur fires.
                    commit(name);
                });
                item.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    commit(name);
                });
                list.appendChild(item);
            });
        });

        input.addEventListener('keydown', function(e) {
            const box = listWrap.querySelector('.autocomplete-items');
            const items = box ? box.querySelectorAll('div') : null;
            if (!items || items.length === 0) return;
            if (e.keyCode === 40) { // down
                currentFocus++; addActive(Array.from(items));
            } else if (e.keyCode === 38) { // up
                currentFocus--; addActive(Array.from(items));
            } else if (e.keyCode === 13) { // enter
                e.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) items[currentFocus].dispatchEvent(new Event('mousedown'));
            }
        });

        document.addEventListener('click', function(e) { closeAllLists(e.target); });
    }

    // Positions (explicit Position field)
    function readPositionsCatalog() {
        try {
            const el = document.getElementById('positions-data');
            if (el && el.dataset && el.dataset.positions) {
                const arr = JSON.parse(el.dataset.positions) || [];
                return Array.isArray(arr) ? arr : [];
            }
        } catch (e) {}
        return [];
    }

    function isoDay(s) {
        const v = String(s || '').trim();
        return v.length >= 10 ? v.slice(0, 10) : v;
    }

    function derivePosition(counterparty, currency, tdate) {
        const party = String(counterparty || '').trim() || '—';
        const ccy = String(currency || '').trim().toUpperCase() || 'EUR';
        const day = isoDay(tdate) || 'unknown-date';
        return `${party} | ${ccy} | ${day}`;
    }

    function getLoansPositionEls(prefix) {
        const isUpdate = prefix === 'update';
        return {
            typeEl: document.getElementById(isUpdate ? 'updateLoansType' : 'loansType'),
            actionEl: document.getElementById(isUpdate ? 'updateLoansAction' : 'loansAction'),
            partyEl: document.getElementById(isUpdate ? 'updateLoansCounterparty' : 'loansCounterparty'),
            currencyEl: document.getElementById(isUpdate ? 'updateLoansCurrency' : 'loansCurrency'),
            dateEl: document.getElementById(isUpdate ? 'updateLoansDate' : 'loansDate'),
            selectEl: document.getElementById(isUpdate ? 'updateLoansPositionSelect' : 'loansPositionSelect'),
            hiddenEl: document.getElementById(isUpdate ? 'updateLoansPosition' : 'loansPosition'),
            formEl: document.getElementById(isUpdate ? 'updateForm' : 'createLoanForm'),
        };
    }

    function refreshLoansPositionOptions(prefix, keepSelection) {
        const els = getLoansPositionEls(prefix);
        if (!els.selectEl || !els.hiddenEl) return;

        const isUpdateForm = prefix === 'update';

        const catalog = window.loansPositionsCatalog || [];
        const typeVal = String(els.typeEl?.value || '').trim().toLowerCase();
        const actionVal = String(els.actionEl?.value || '').trim().toLowerCase();
        const partyVal = String(els.partyEl?.value || '').trim();
        const ccyVal = String(els.currencyEl?.value || '').trim().toUpperCase();

        const current = keepSelection ? String(els.selectEl.value || '') : '';

        const isRepay = actionVal === 'repay';
        const matches = catalog
            .filter(p => String(p?.type || '').toLowerCase() === typeVal)
            .filter(p => !partyVal || String(p?.counterparty || '').trim().toLowerCase() === partyVal.toLowerCase())
            .filter(p => !ccyVal || String(p?.currency || '').trim().toUpperCase() === ccyVal)
            .map(p => String(p.position || '').trim())
            .filter(Boolean);

        const uniq = Array.from(new Set(matches));

        // Rebuild select options.
        els.selectEl.innerHTML = '';

        // Placeholder behaviour:
        // - Create form: show a placeholder until counterparty is set
        // - Repay: always show "-- Select position --"
        if (isRepay) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '-- Select position --';
            els.selectEl.appendChild(opt);
        } else if (!isUpdateForm) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = partyVal ? '-- Select position (optional) --' : '-- Select counterparty first --';
            els.selectEl.appendChild(opt);
        }

        const newOpt = document.createElement('option');
        newOpt.value = '__new__';
        newOpt.textContent = 'New position';
        if (isRepay) newOpt.disabled = true;
        els.selectEl.appendChild(newOpt);

        // Only suggest existing positions after a counterparty is entered.
        if (partyVal) {
            uniq.forEach(pos => {
                const opt = document.createElement('option');
                opt.value = pos;
                opt.textContent = pos;
                els.selectEl.appendChild(opt);
            });
        }

        // Ensure current position (from edit) remains selectable even if not in catalog.
        const existingHidden = String(els.hiddenEl.value || '').trim();
        if (isUpdateForm && existingHidden && !uniq.includes(existingHidden)) {
            const opt = document.createElement('option');
            opt.value = existingHidden;
            opt.textContent = existingHidden;
            els.selectEl.appendChild(opt);
        }

        // Restore selection:
        // - Update form: prefer hidden value (existing tx), then prior selection.
        // - Create form:
        //   - If counterparty empty: stay blank
        //   - Else default to New position (unless user selected an existing one)
        let next = isUpdateForm ? (existingHidden || current) : current;
        if (!next) {
            if (isRepay) next = '';
            else if (!partyVal) next = '';
            else next = '__new__';
        }
        if (isRepay && next === '__new__') next = '';
        els.selectEl.value = next;

        syncLoansPositionHidden(prefix);
    }

    function syncLoansPositionHidden(prefix) {
        const els = getLoansPositionEls(prefix);
        if (!els.selectEl || !els.hiddenEl) return;

        const actionVal = String(els.actionEl?.value || '').trim().toLowerCase();
        const sel = String(els.selectEl.value || '');

        if (actionVal === 'repay') {
            els.hiddenEl.value = sel && sel !== '__new__' ? sel : '';
            return;
        }

        if (!sel || sel === '__new__') {
            const pos = derivePosition(els.partyEl?.value, els.currencyEl?.value, els.dateEl?.value);
            els.hiddenEl.value = pos;
        } else {
            els.hiddenEl.value = sel;
        }
    }

    function validateLoansPositionOnSubmit(prefix, e) {
        const els = getLoansPositionEls(prefix);
        if (!els.formEl) return;
        const actionVal = String(els.actionEl?.value || '').trim().toLowerCase();
        syncLoansPositionHidden(prefix);

        // If a standard position string is selected, ensure party/currency match to avoid inconsistent rows.
        const posVal = String(els.hiddenEl?.value || '').trim();
        const parts = posVal.split(' | ');
        if (parts.length >= 3) {
            const expectedParty = String(parts[0] || '').trim().toLowerCase();
            const expectedCcy = String(parts[1] || '').trim().toUpperCase();
            const actualParty = String(els.partyEl?.value || '').trim().toLowerCase();
            const actualCcy = String(els.currencyEl?.value || '').trim().toUpperCase();
            if (expectedParty && expectedParty !== '—' && actualParty && expectedParty !== actualParty) {
                if (e && typeof e.preventDefault === 'function') e.preventDefault();
                alert('Selected Position does not match the Counterparty.');
                return false;
            }
            if (expectedCcy && actualCcy && expectedCcy !== actualCcy) {
                if (e && typeof e.preventDefault === 'function') e.preventDefault();
                alert('Selected Position does not match the Currency.');
                return false;
            }
        }
        if (actionVal === 'repay') {
            if (!posVal) {
                if (e && typeof e.preventDefault === 'function') e.preventDefault();
                alert('Please select an existing Position for Repay.');
                return false;
            }
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Apply percent-fill widths for progress bars.
        const fills = document.querySelectorAll('.pct-fill');
        fills.forEach(f => {
            const v = f.getAttribute('data-fill');
            if (v !== null && v !== undefined) {
                const num = parseFloat(v) || 0;
                f.style.width = (Math.max(0, Math.min(100, num))) + '%';
            }
        });

        // Counterparty autocomplete: suggest previously used names.
        let names = [];
        try {
            const el = document.getElementById('counterparties-data');
            if (el && el.dataset && el.dataset.counterparties) {
                names = JSON.parse(el.dataset.counterparties) || [];
            }
        } catch (e) { names = []; }

        window.loansPositionsCatalog = readPositionsCatalog();

        initCounterpartyAutocomplete('loansCounterparty', 'loansCounterpartyList', names, function() {
            refreshLoansPositionOptions('create', true);
        });
        initCounterpartyAutocomplete('updateLoansCounterparty', 'updateLoansCounterpartyList', names, function() {
            refreshLoansPositionOptions('update', true);
        });
        initCounterpartyAutocomplete('filterParty', 'filterPartyList', names, function() {
            if (typeof applyLoansFilters === 'function') {
                window.loansCurrentPage = 1;
                applyLoansFilters();
            }
        });
    });

    function setLoansNavVisibility(activeView) {
        const btns = Array.from(document.querySelectorAll('[data-loans-nav]'));
        btns.forEach(btn => {
            const v = String(btn.getAttribute('data-loans-nav') || '').trim();
            const isActive = (v && v === String(activeView || ''));
            if (isActive) btn.setAttribute('aria-current', 'page');
            else btn.removeAttribute('aria-current');
            btn.classList.toggle('is-active', isActive);
        });
    }

    function showLoansPortfolio() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Borrow & Lend';
        if (panel) panel.style.display = 'block';
        if (listDiv) listDiv.style.display = 'none';
        if (newDiv) newDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';

        setLoansNavVisibility('portfolio');
    }

    function showLoansNew() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'New Loan Transaction';
        if (newDiv) newDiv.style.display = 'block';
        if (updateDiv) updateDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';

        setLoansNavVisibility('new');
    }

    function showLoansHistory() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Loans Transactions History';
        if (listDiv) listDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';

        setLoansNavVisibility('history');
        if (typeof applyLoansFilters === 'function') { applyLoansFilters(); }
    }

    function showLoansUpdate() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Update Loan Transaction';
        if (updateDiv) updateDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';

        setLoansNavVisibility('update');
    }

    // Keep old name for sidebar submenu compatibility
    function showLoansOverview() { showLoansPortfolio(); }
    window.showLoansOverview = showLoansOverview;
    window.showLoansPortfolio = showLoansPortfolio;
    window.showLoansNew = showLoansNew;
    window.showLoansHistory = showLoansHistory;

    function editLoan(loanId, userId, type, action, counterparty, amount, currency, fromWallet, toWallet, fee, tdate, ddate, position, note) {
        document.getElementById('updateLoanId').value = loanId || '';
        document.getElementById('updateUserId').value = userId || '';
        document.getElementById('updateLoansType').value = (type || 'borrow');
        document.getElementById('updateLoansAction').value = (action || 'new');
        // Locked fields: keep values submitted via hidden inputs.
        const lockedType = document.getElementById('updateLockedType');
        if (lockedType) lockedType.value = (type || 'borrow');
        const lockedAction = document.getElementById('updateLockedAction');
        if (lockedAction) lockedAction.value = (action || 'new');
        document.getElementById('updateLoansCounterparty').value = counterparty || '';
        document.getElementById('updateLoansAmount').value = amount || '';
        if (currency) document.getElementById('updateLoansCurrency').value = String(currency).toUpperCase();
        const lockedCurrency = document.getElementById('updateLockedCurrency');
        if (lockedCurrency) lockedCurrency.value = currency ? String(currency).toUpperCase() : '';
        document.getElementById('updateFromWallet').value = (fromWallet && String(fromWallet) !== 'None') ? fromWallet : '';
        document.getElementById('updateToWallet').value = (toWallet && String(toWallet) !== 'None') ? toWallet : '';
        const feeEl = document.getElementById('updateFee');
        if (feeEl) feeEl.value = (fee != null ? fee : '');

        {
            const el = document.getElementById('updateLoansDate');
            if (el && el._flatpickr) el._flatpickr.setDate(tdate, false, 'Y-m-d\\TH:i');
            else if (el) el.value = tdate || '';
            const lockedTdate = document.getElementById('updateLockedTdate');
            if (lockedTdate) lockedTdate.value = tdate || '';
            // Prevent edits / calendar popover.
            if (el) {
                el.disabled = true;
                try {
                    if (el._flatpickr) {
                        el._flatpickr.set('clickOpens', false);
                        el._flatpickr.close();
                        el._flatpickr._input.setAttribute('disabled', 'disabled');
                        if (typeof el._flatpickr.disable === 'function') el._flatpickr.disable();
                    }
                } catch(e) {}
            }
        }
        {
            const el = document.getElementById('updateLoansDDate');
            if (el && el._flatpickr) el._flatpickr.setDate(ddate, false, 'Y-m-d\\TH:i');
            else if (el) el.value = ddate || '';
        }

        document.getElementById('updateLoansNote').value = note || '';
        const posHidden = document.getElementById('updateLoansPosition');
        if (posHidden) posHidden.value = String(position || '').trim();
        refreshLoansPositionOptions('update', true);

        // Hard-lock requested fields.
        try { document.getElementById('updateLoansType').disabled = true; } catch(e) {}
        try { document.getElementById('updateLoansAction').disabled = true; } catch(e) {}
        try { document.getElementById('updateLoansCurrency').disabled = true; } catch(e) {}
        try { document.getElementById('updateLoansPositionSelect').disabled = true; } catch(e) {}
        try { document.getElementById('updateLoansCounterparty').readOnly = true; } catch(e) {}

        document.getElementById('deleteForm').action = `/deleteloan/${encodeURIComponent(loanId || '')}`;
        applyLoansTypeActionRules('update');
        showLoansUpdate();
    }
    window.editLoan = editLoan;

    function editLoanFromRow(buttonEl) {
        const li = buttonEl?.closest('li[data-id]');
        if (!li) return;
        editLoan(
            li.dataset.id,
            li.dataset.userid,
            li.dataset.type,
            li.dataset.action,
            li.dataset.party,
            li.dataset.amount,
            li.dataset.currency,
            li.dataset.from,
            li.dataset.to,
            li.dataset.fee,
            li.dataset.tdate,
            li.dataset.ddate,
            li.dataset.position,
            li.dataset.note
        );
    }
    window.editLoanFromRow = editLoanFromRow;

    function setRowVisibility(rowEl, inputEl, visible) {
        if (!rowEl || !inputEl) return;
        rowEl.style.display = visible ? '' : 'none';
        // Wallet fields are optional. Keep inputs enabled so they submit
        // even when hidden (empty string), and never mark them as required.
        if (!visible) {
            if (inputEl.tagName === 'SELECT') inputEl.selectedIndex = 0;
            else inputEl.value = '';
        }
    }

    function applyLoansTypeActionRules(prefix) {
        const isUpdate = prefix === 'update';

        const typeEl = document.getElementById(isUpdate ? 'updateLoansType' : 'loansType');
        const actionEl = document.getElementById(isUpdate ? 'updateLoansAction' : 'loansAction');

        const fromRow = document.getElementById(isUpdate ? 'updateFromWalletRow' : 'loansFromWalletRow');
        const toRow = document.getElementById(isUpdate ? 'updateToWalletRow' : 'loansToWalletRow');
        const dueRow = document.getElementById(isUpdate ? 'updateDDateRow' : 'loansDDateRow');

        const fromEl = document.getElementById(isUpdate ? 'updateFromWallet' : 'fromWallet');
        const toEl = document.getElementById(isUpdate ? 'updateToWallet' : 'toWallet');
        const dueEl = document.getElementById(isUpdate ? 'updateLoansDDate' : 'loansDDate');

        const typeVal = String(typeEl?.value || '').toLowerCase();
        const actionVal = String(actionEl?.value || '').toLowerCase();

        const isNew = actionVal === 'new';
        const isRepay = actionVal === 'repay';
        const isBorrow = typeVal === 'borrow' || typeVal === 'loan';
        const isLend = typeVal === 'lend';

        // Wallet rules:
        // - borrow+new: toWallet required
        // - borrow+repay: fromWallet required
        // - lend+new: fromWallet required
        // - lend+repay: toWallet required
        let showFrom = false;
        let showTo = false;

        if (isBorrow && isNew) showTo = true;
        else if (isBorrow && isRepay) showFrom = true;
        else if (isLend && isNew) showFrom = true;
        else if (isLend && isRepay) showTo = true;
        else {
            // Fallback (unknown values): show both but not required
            showFrom = true;
            showTo = true;
        }

        setRowVisibility(fromRow, fromEl, showFrom);
        setRowVisibility(toRow, toEl, showTo);

        // Due date only for new
        if (dueRow && dueEl) {
            dueRow.style.display = isNew ? '' : 'none';
            dueEl.disabled = !isNew;
            if (!isNew) {
                if (dueEl._flatpickr) dueEl._flatpickr.clear();
                dueEl.value = '';
            }
        }

        refreshLoansPositionOptions(isUpdate ? 'update' : 'create', true);
    }
    window.applyLoansTypeActionRules = applyLoansTypeActionRules;

    // Utilities for history filtering/pagination/month grouping (mirrors Crypto)
    function parseLocalDateTime(val) {
        if (!val) return null;
        try { return new Date(val); } catch(e) { return null; }
    }
    function parseTxDate(val) {
        if (!val) return null;
        let s = String(val);
        let d = new Date(s);
        if (isNaN(d)) d = new Date(s.replace(' ', 'T'));
        return isNaN(d) ? null : d;
    }
    function monthKeyFromDate(d) {
        if (!d || isNaN(d)) return 'unknown';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
    }
    function monthLabelFromDate(d) {
        if (!d || isNaN(d)) return 'Unknown date';
        try {
            return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
    }
    function buildLoansMonthGroups() {
        const list = document.getElementById('loansList');
        if (!list) return;
        list.querySelectorAll('li.crypto-group-header').forEach(h => h.remove());
        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        if (!txItems.length) return;
        let currentKey = null;
        txItems.forEach(li => {
            const d = parseTxDate(li.getAttribute('data-tdate'));
            const key = monthKeyFromDate(d);
            li.setAttribute('data-group', key);
            if (key !== currentKey) {
                const header = document.createElement('li');
                header.className = 'crypto-group-header';
                header.setAttribute('data-group', key);
                header.textContent = monthLabelFromDate(d);
                list.insertBefore(header, li);
                currentKey = key;
            }
        });
    }
    function syncLoansGroupHeaders() {
        const list = document.getElementById('loansList');
        if (!list) return;
        const headers = Array.from(list.querySelectorAll('li.crypto-group-header'));
        if (!headers.length) return;
        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        headers.forEach(h => {
            const key = h.getAttribute('data-group') || '';
            const anyVisible = txItems.some(li => {
                if ((li.getAttribute('data-group') || '') !== key) return false;
                return li.style.display !== 'none';
            });
            h.style.display = anyVisible ? '' : 'none';
        });
    }
    function ensureLoansGroupsBuilt(force) {
        const list = document.getElementById('loansList');
        if (!list) return;
        const hasHeaders = !!list.querySelector('li.crypto-group-header');
        if (force || !hasHeaders) buildLoansMonthGroups();
        syncLoansGroupHeaders();
    }

    function applyLoansFilters() {
        const list = document.getElementById('loansList');
        if (!list) return;
        ensureLoansGroupsBuilt(false);
        const items = Array.from(list.querySelectorAll('li[data-tdate]'));
        const startVal = document.getElementById('filterStart')?.value || '';
        const endVal = document.getElementById('filterEnd')?.value || '';
        const typeVal = (document.getElementById('filterType')?.value || '').trim().toLowerCase();
        const actionVal = (document.getElementById('filterAction')?.value || '').trim().toLowerCase();
        const partyVal = (document.getElementById('filterParty')?.value || '').trim().toLowerCase();
        const noteVal = (document.getElementById('filterNote')?.value || '').trim().toLowerCase();
        const fromVal = String(document.getElementById('filterFromWallet')?.value || '').trim();
        const toVal = String(document.getElementById('filterToWallet')?.value || '').trim();
        const startDt = parseLocalDateTime(startVal);
        const endDt = parseLocalDateTime(endVal);

        if (window.loansPageSize == null) window.loansPageSize = 20;
        if (window.loansCurrentPage == null) window.loansCurrentPage = 1;

        function itemMatches(li) {
            let show = true;
            const tdate = parseTxDate(li.getAttribute('data-tdate'));
            if (startDt && tdate && tdate < startDt) show = false;
            if (endDt && tdate && tdate > endDt) show = false;
            if ((startDt || endDt) && !tdate) show = false;

            if (show && typeVal) {
                const t = (li.getAttribute('data-type') || '').toLowerCase();
                if (!t.includes(typeVal)) show = false;
            }
            if (show && actionVal) {
                const a = (li.getAttribute('data-action') || '').toLowerCase();
                if (!a.includes(actionVal)) show = false;
            }
            if (show && partyVal) {
                const p = (li.getAttribute('data-party') || '').toLowerCase();
                if (!p.includes(partyVal)) show = false;
            }
            if (show && noteVal) {
                const n = (li.getAttribute('data-note') || '').toLowerCase();
                if (!n.includes(noteVal)) show = false;
            }
            if (show && fromVal) {
                const f = String(li.getAttribute('data-from') || '').trim();
                if (f !== fromVal) show = false;
            }
            if (show && toVal) {
                const t = String(li.getAttribute('data-to') || '').trim();
                if (t !== toVal) show = false;
            }
            return show;
        }

        const matching = items.filter(itemMatches);
        const total = matching.length;
        const pageSize = Number(window.loansPageSize) || 20;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        window.loansCurrentPage = Math.min(Math.max(1, Number(window.loansCurrentPage) || 1), totalPages);

        items.forEach(li => { li.style.display = 'none'; });
        const startIdx = (window.loansCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        matching.slice(startIdx, endIdx).forEach(li => { li.style.display = ''; });
        syncLoansGroupHeaders();

        const emptyMsg = document.getElementById('filterEmptyMsg');
        if (emptyMsg) emptyMsg.style.display = total ? 'none' : '';

        const pager = document.getElementById('loansPagination');
        const pageInfo = document.getElementById('loansPageInfo');
        const prevBtn = document.getElementById('loansPrevPage');
        const nextBtn = document.getElementById('loansNextPage');
        if (pager) pager.style.display = total ? '' : 'none';
        if (pageInfo) pageInfo.textContent = `Page ${window.loansCurrentPage} of ${totalPages}`;
        if (prevBtn) prevBtn.disabled = window.loansCurrentPage <= 1;
        if (nextBtn) nextBtn.disabled = window.loansCurrentPage >= totalPages;
    }
    window.applyLoansFilters = applyLoansFilters;

    function resetLoansFilters() {
        ['filterStart','filterEnd','filterType','filterAction','filterParty','filterNote','filterFromWallet','filterToWallet'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el._flatpickr) {
                el._flatpickr.clear();
                return;
            }
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        });
        window.loansCurrentPage = 1;
        applyLoansFilters();
    }
    window.resetLoansFilters = resetLoansFilters;

    function loansGoToPrevPage() {
        window.loansCurrentPage = Math.max(1, (Number(window.loansCurrentPage) || 1) - 1);
        applyLoansFilters();
    }
    function loansGoToNextPage() {
        window.loansCurrentPage = (Number(window.loansCurrentPage) || 1) + 1;
        applyLoansFilters();
    }
    window.loansGoToPrevPage = loansGoToPrevPage;
    window.loansGoToNextPage = loansGoToNextPage;

    document.addEventListener('DOMContentLoaded', function() {
        // Sort newest-first, then build month headers
        const list = document.getElementById('loansList');
        if (list && list.children && list.children.length) {
            const items = Array.from(list.querySelectorAll('li[data-tdate]'));
            if (items.length > 1) {
                items.sort((a, b) => {
                    let dateA = new Date(a.getAttribute('data-tdate') || 0);
                    let dateB = new Date(b.getAttribute('data-tdate') || 0);
                    return dateB - dateA;
                });
                items.forEach(item => list.appendChild(item));
            }
            ensureLoansGroupsBuilt(true);
        }

        const fStart = document.getElementById('filterStart');
        const fEnd = document.getElementById('filterEnd');
        const fType = document.getElementById('filterType');
        const fAction = document.getElementById('filterAction');
        const fParty = document.getElementById('filterParty');
        const fNote = document.getElementById('filterNote');
        const fFrom = document.getElementById('filterFromWallet');
        const fTo = document.getElementById('filterToWallet');
        ['input','change'].forEach(evt => {
            if (fStart) fStart.addEventListener(evt, applyLoansFilters);
            if (fEnd) fEnd.addEventListener(evt, applyLoansFilters);
            if (fType) fType.addEventListener(evt, applyLoansFilters);
            if (fAction) fAction.addEventListener(evt, applyLoansFilters);
            if (fParty) fParty.addEventListener(evt, applyLoansFilters);
            if (fNote) fNote.addEventListener(evt, applyLoansFilters);
            if (fFrom) fFrom.addEventListener(evt, applyLoansFilters);
            if (fTo) fTo.addEventListener(evt, applyLoansFilters);
        });

        const createType = document.getElementById('loansType');
        const createAction = document.getElementById('loansAction');
        const createParty = document.getElementById('loansCounterparty');
        const createCcy = document.getElementById('loansCurrency');
        const createDate = document.getElementById('loansDate');
        const createPosSel = document.getElementById('loansPositionSelect');
        const createForm = document.getElementById('createLoanForm');
        if (createType) createType.addEventListener('change', () => applyLoansTypeActionRules('create'));
        if (createAction) createAction.addEventListener('change', () => applyLoansTypeActionRules('create'));
        if (createParty) createParty.addEventListener('input', () => refreshLoansPositionOptions('create', true));
        if (createCcy) createCcy.addEventListener('change', () => refreshLoansPositionOptions('create', true));
        if (createDate) createDate.addEventListener('change', () => syncLoansPositionHidden('create'));
        if (createPosSel) createPosSel.addEventListener('change', () => syncLoansPositionHidden('create'));
        if (createForm) createForm.addEventListener('submit', (e) => validateLoansPositionOnSubmit('create', e));
        applyLoansTypeActionRules('create');

        const updType = document.getElementById('updateLoansType');
        const updAction = document.getElementById('updateLoansAction');
        const updParty = document.getElementById('updateLoansCounterparty');
        const updCcy = document.getElementById('updateLoansCurrency');
        const updDate = document.getElementById('updateLoansDate');
        const updPosSel = document.getElementById('updateLoansPositionSelect');
        const updForm = document.getElementById('updateForm');
        if (updType) updType.addEventListener('change', () => applyLoansTypeActionRules('update'));
        if (updAction) updAction.addEventListener('change', () => applyLoansTypeActionRules('update'));
        if (updParty) updParty.addEventListener('input', () => refreshLoansPositionOptions('update', true));
        if (updCcy) updCcy.addEventListener('change', () => refreshLoansPositionOptions('update', true));
        if (updDate) updDate.addEventListener('change', () => syncLoansPositionHidden('update'));
        if (updPosSel) updPosSel.addEventListener('change', () => syncLoansPositionHidden('update'));
        if (updForm) updForm.addEventListener('submit', (e) => validateLoansPositionOnSubmit('update', e));
        applyLoansTypeActionRules('update');

        showLoansPortfolio();
    });
</script>

{% else %}
<script>
    window.location.replace('/login');
</script>
{% endif %}
{% endblock %}
