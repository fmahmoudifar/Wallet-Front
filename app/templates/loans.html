{% extends "layout.html" %}
{% block head_extra %}
    <link rel="stylesheet" href="/static/css/site_styles.css">
{% endblock %}

{% block content %}
{% if session.get('user') %}

<div class="crypto-page-header">
    <h1 id="loansPageTitle" class="crypto-page-title">Borrow &amp; Lend</h1>
</div>

<div class="app-subnav app-subnav-mobile" aria-label="Loans sections">
    <button type="button" class="app-subnav-link" data-loans-nav="portfolio" onclick="showLoansPortfolio()">Overview</button>
    <button type="button" class="app-subnav-link" data-loans-nav="new" onclick="showLoansNew()">New</button>
    <button type="button" class="app-subnav-link" data-loans-nav="history" onclick="showLoansHistory()">History</button>
</div>

<div id="panel" class="panel" style="padding:12px;margin-bottom:12px;">
    <div class="totals-card" style="width:100%;max-width:1100px;">
        <div class="crypto-page-title" style="margin:0 0 6px 0;">Overview</div>
        <div class="small-muted">Track who owes you, what you owe, and due dates.</div>

        <div class="totals-grid" style="margin-top:12px;">
            <div class="totals-card" style="box-shadow:none;">
                <div class="small-muted" style="font-weight:700;">You will receive</div>
                <div class="totals-value" style="margin-top:4px;">{{ receive_total|default(0) }}{% if base_currency %} {{ base_currency }}{% endif %}</div>
            </div>
            <div class="totals-card" style="box-shadow:none;">
                <div class="small-muted" style="font-weight:700;">You owe</div>
                <div class="totals-value" style="margin-top:4px;">{{ owe_total|default(0) }}{% if base_currency %} {{ base_currency }}{% endif %}</div>
            </div>
        </div>
    </div>
</div>

<div id="newLoan" class="block-new" style="display: none;">
    <h2 class="center-text" style="display:none;">Add New Transaction</h2>
    <div class="form-container">
        <form id="createLoanForm" action="/loans" method="POST">
            <div>
                <label for="loansType">Type</label>
                <select id="loansType" name="type">
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>

            <div>
                <label for="loansStatus">Status</label>
                <select id="loansStatus" name="status">
                    <option value="open">Open</option>
                    <option value="paid">Paid</option>
                </select>
            </div>

            <div>
                <label for="loansCounterparty">Counterparty</label>
                <input id="loansCounterparty" type="text" name="counterparty" placeholder="Name" required>
            </div>

            <div>
                <label for="loansAmount">Amount</label>
                <input id="loansAmount" type="number" name="amount" step="any" inputmode="decimal" placeholder="0" required>
            </div>

            <div>
                <label for="loansCurrency">Currency</label>
                <select id="loansCurrency" name="currency" required>
                    {% set _ccy = (session.get('currency') or 'EUR')|upper %}
                    <option value="EUR" {% if _ccy == 'EUR' %}selected{% endif %}>EUR</option>
                    <option value="USD" {% if _ccy == 'USD' %}selected{% endif %}>USD</option>
                </select>
            </div>

            <div>
                <label for="fromWallet">From Wallet:</label>
                <select name="fromWallet" id="fromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="toWallet">To Wallet:</label>
                <select name="toWallet" id="toWallet" required>
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="loansDate">Date</label>
                <input id="loansDate" type="text" name="tdate" data-dt-picker="1" placeholder="Select date" required>
            </div>

            <div>
                <label for="loansDueDate">Due date (optional)</label>
                <input id="loansDueDate" type="text" name="dueDate" data-dt-picker="1" placeholder="Select due date">
            </div>

            <div>
                <label for="loansNote">Note</label>
                <input id="loansNote" type="text" name="note" placeholder="Optional">
            </div>

            <div>
                <label for="loansFee">Fee:</label>
                <input id="loansFee" type="number" name="fee" step="any" inputmode="decimal" placeholder="0">
            </div>

            <div>
                <button type="submit" class="btn-insert pct-positive">Insert</button>
                <button type="reset" class="btn-clear">Clear</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="loansListDiv" class="form-container" style="display: none;" >
    <div id="loansFilters" class="history-filters" style="width:100%;max-width:1100px;">
        <form class="filters-grid" onsubmit="applyLoansFilters(); return false;">
            <div>
                <label for="filterStart">From Date:</label>
                <input type="text" id="filterStart" name="start" data-dt-picker="1">
            </div>
            <div>
                <label for="filterEnd">To Date:</label>
                <input type="text" id="filterEnd" name="end" data-dt-picker="1">
            </div>
            <div>
                <label for="filterType">Type:</label>
                <select id="filterType" name="type">
                    <option value="">-- All --</option>
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>
            <div>
                <label for="filterParty">Counterparty:</label>
                <input type="text" id="filterParty" name="party" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="filterNote">Note:</label>
                <input type="text" id="filterNote" name="note" placeholder="Contains..." autocomplete="off" />
            </div>
            <div>
                <label for="filterFromWallet">From Wallet:</label>
                <select id="filterFromWallet" name="fromWallet">
                    <option value="">-- Any --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="filterToWallet">To Wallet:</label>
                <select id="filterToWallet" name="toWallet">
                    <option value="">-- Any --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                    <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filters-actions">
                <button type="button" class="btn-clear" onclick="resetLoansFilters()">Clear</button>
            </div>
        </form>
        <div id="filterEmptyMsg" class="small-muted" style="display:none;margin-top:8px">No matching transactions.</div>
        <div id="loansPagination" class="pagination-controls" style="display:none;margin-top:10px">
            <button id="loansPrevPage" type="button" class="btn-clear" onclick="loansGoToPrevPage()">Prev</button>
            <div id="loansPageInfo" class="small-muted" style="min-width:140px;text-align:center">Page 1 of 1</div>
            <button id="loansNextPage" type="button" class="btn-clear" onclick="loansGoToNextPage()">Next</button>
        </div>
    </div>

    {% if loans and loans|length %}
    {% set walletNameById = {} %}
    {% for w in wallets %}
        {% if w['walletId'] is defined %}
            {% set _ = walletNameById.update({ w['walletId']: (w['walletName']|default(w['walletId'])) }) %}
        {% endif %}
    {% endfor %}
    <ul id="loansList">
        {% for tx in loans %}
        {% set _loan_id = (tx.loanId or tx.id)|default('', true) %}
        {% set _uid = tx.userId|default(((session.get('user') or {}).get('username','')), true) %}
        {% set _type = (tx.type|default('loan', true))|lower %}
        {% set _status = (tx.status|default('open', true))|lower %}
        {% set _party = tx.counterparty|default('', true) %}
        {% set _note = tx.note|default('', true) %}
        {% set _amount = tx.amount|default('0', true) %}
        {% set _currency = (tx.currency|default((session.get('currency') or 'EUR')|upper, true))|upper %}
        {% set _wallet_id = tx.walletId|default('', true) %}
        {% set _tdate = tx.tdate|default('', true) %}
        {% set _due = tx.dueDate|default('', true) %}
        {% set _fee = tx.fee|default(0, true) %}
        {% set _from = '' if (tx.fromWallet|default('', true)) == 'None' else (tx.fromWallet|default('', true)) %}
        {% set _to = '' if (tx.toWallet|default('', true)) == 'None' else (tx.toWallet|default('', true)) %}
        <li data-id="{{ _loan_id }}" data-userid="{{ _uid }}" data-tdate="{{ _tdate }}" data-type="{{ _type }}" data-status="{{ _status }}" data-party="{{ _party }}" data-amount="{{ _amount }}" data-currency="{{ _currency }}" data-walletid="{{ _wallet_id }}" data-duedate="{{ _due }}" data-fee="{{ _fee }}" data-note="{{ _note }}" data-from="{{ _from }}" data-to="{{ _to }}">
            <div class="crypto-history-row">
                <div class="crypto-history-left">
                    <div class="crypto-history-title">{{ _party if _party else '—' }}</div>
                    <div class="crypto-history-sub">{{ _type }}{% if _status %} • {{ _status }}{% endif %}</div>
                    {% set fromName = walletNameById.get(_from, _from) %}
                    {% set toName = walletNameById.get(_to, _to) %}
                    {% if fromName or toName %}
                    <div class="crypto-history-sub">{% if fromName and toName %}{{ fromName }} -> {{ toName }}{% else %}{{ fromName or toName }}{% endif %}</div>
                    {% endif %}
                </div>

                <div class="crypto-history-right">
                    <div class="crypto-history-amount">{{ _amount }}{% if _currency %} {{ _currency }}{% endif %}</div>
                    {% if _fee and _fee != 0 and _fee != '0' %}
                    <div class="crypto-history-sub">Fee: {{ _fee }}{% if _currency %} {{ _currency }}{% endif %}</div>
                    {% endif %}
                    {% if _note %}
                    <div class="crypto-history-sub">{{ _note }}</div>
                    {% endif %}
                </div>

                <div class="crypto-history-actions">
                    <button class="btn-insert" type="button" onclick="editLoanFromRow(this)">Edit</button>
                </div>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="totals-card" style="width:100%;max-width:1100px;">
        <div class="crypto-page-title" style="margin:0 0 6px 0;">Transactions History</div>
        <div class="small-muted">No loan transactions yet.</div>
    </div>
    {% endif %}
</div>

<div id="updateLoanDiv" class="block-update" style="display: none;">
    <h2 class="center-text" style="display:none;">Update Loan Transaction</h2>
    <div class="form-container">
        <form id="updateForm" action="/updateLoan" method="POST">
            <input type="hidden" id="updateLoanId" name="loanId" />
            <input type="hidden" id="updateUserId" name="userId" />

            <div>
                <label for="updateLoansType">Type</label>
                <select id="updateLoansType" name="type" required>
                    <option value="borrow">Borrow</option>
                    <option value="lend">Lend</option>
                    <option value="loan">Loan</option>
                </select>
            </div>

            <div>
                <label for="updateLoansStatus">Status</label>
                <select id="updateLoansStatus" name="status" required>
                    <option value="open">Open</option>
                    <option value="paid">Paid</option>
                </select>
            </div>

            <div>
                <label for="updateLoansCounterparty">Counterparty</label>
                <input id="updateLoansCounterparty" type="text" name="counterparty" placeholder="Name" required />
            </div>

            <div>
                <label for="updateLoansAmount">Amount</label>
                <input id="updateLoansAmount" type="number" name="amount" step="any" inputmode="decimal" required />
            </div>

            <div>
                <label for="updateLoansCurrency">Currency</label>
                <select id="updateLoansCurrency" name="currency" required>
                    {% set _ccy2 = (session.get('currency') or 'EUR')|upper %}
                    <option value="EUR" {% if _ccy2 == 'EUR' %}selected{% endif %}>EUR</option>
                    <option value="USD" {% if _ccy2 == 'USD' %}selected{% endif %}>USD</option>
                </select>
            </div>

            <div>
                <label for="updateFromWallet">From Wallet:</label>
                <select name="fromWallet" id="updateFromWallet">
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="updateToWallet">To Wallet:</label>
                <select name="toWallet" id="updateToWallet" required>
                    <option value="">-- Select Wallet --</option>
                    {% for wallet in wallets|sort(attribute='walletName', case_sensitive=false) %}
                        <option value="{{ wallet['walletId'] }}">{{ wallet['walletName'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="updateLoansDate">Date</label>
                <input id="updateLoansDate" type="text" name="tdate" data-dt-picker="1" placeholder="Select date" required />
            </div>

            <div>
                <label for="updateLoansDueDate">Due date (optional)</label>
                <input id="updateLoansDueDate" type="text" name="dueDate" data-dt-picker="1" placeholder="Select due date" />
            </div>

            <div>
                <label for="updateLoansNote">Note</label>
                <input id="updateLoansNote" type="text" name="note" placeholder="Optional" />
            </div>

            <div>
                <label for="updateFee">Fee:</label>
                <input type="number" id="updateFee" name="fee" step="any" inputmode="decimal" placeholder="0">
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button type="submit" class="btn-insert pct-positive">Save</button>
                <button type="submit" form="deleteForm" class="btn-delete" onclick="return confirm('Are you sure?')">Delete</button>
                <button type="button" class="btn-cancel" onclick="location.reload();">Cancel</button>
            </div>
        </form>
    </div>

    <form id="deleteForm" method="POST"></form>
</div>

<script>
    function setLoansNavVisibility(activeView) {
        const btns = Array.from(document.querySelectorAll('[data-loans-nav]'));
        btns.forEach(btn => {
            const v = String(btn.getAttribute('data-loans-nav') || '').trim();
            const isActive = (v && v === String(activeView || ''));
            if (isActive) btn.setAttribute('aria-current', 'page');
            else btn.removeAttribute('aria-current');
            btn.classList.toggle('is-active', isActive);
        });
    }

    function showLoansPortfolio() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Borrow & Lend';
        if (panel) panel.style.display = 'block';
        if (listDiv) listDiv.style.display = 'none';
        if (newDiv) newDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';

        setLoansNavVisibility('portfolio');
    }

    function showLoansNew() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'New Loan Transaction';
        if (newDiv) newDiv.style.display = 'block';
        if (updateDiv) updateDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';

        setLoansNavVisibility('new');
    }

    function showLoansHistory() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Loans Transactions History';
        if (listDiv) listDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (updateDiv) updateDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';

        setLoansNavVisibility('history');
        if (typeof applyLoansFilters === 'function') { applyLoansFilters(); }
    }

    function showLoansUpdate() {
        const title = document.getElementById('loansPageTitle');
        const panel = document.getElementById('panel');
        const listDiv = document.getElementById('loansListDiv');
        const newDiv = document.getElementById('newLoan');
        const updateDiv = document.getElementById('updateLoanDiv');

        if (title) title.innerText = 'Update Loan Transaction';
        if (updateDiv) updateDiv.style.display = 'block';
        if (newDiv) newDiv.style.display = 'none';
        if (listDiv) listDiv.style.display = 'none';
        if (panel) panel.style.display = 'none';

        setLoansNavVisibility('update');
    }

    // Keep old name for sidebar submenu compatibility
    function showLoansOverview() { showLoansPortfolio(); }
    window.showLoansOverview = showLoansOverview;
    window.showLoansPortfolio = showLoansPortfolio;
    window.showLoansNew = showLoansNew;
    window.showLoansHistory = showLoansHistory;

    function editLoan(loanId, userId, type, status, counterparty, amount, currency, fromWallet, toWallet, fee, tdate, dueDate, note) {
        document.getElementById('updateLoanId').value = loanId || '';
        document.getElementById('updateUserId').value = userId || '';
        document.getElementById('updateLoansType').value = (type || 'loan');
        document.getElementById('updateLoansStatus').value = (status || 'open');
        document.getElementById('updateLoansCounterparty').value = counterparty || '';
        document.getElementById('updateLoansAmount').value = amount || '';
        if (currency) document.getElementById('updateLoansCurrency').value = String(currency).toUpperCase();
        document.getElementById('updateFromWallet').value = (fromWallet && String(fromWallet) !== 'None') ? fromWallet : '';
        document.getElementById('updateToWallet').value = (toWallet && String(toWallet) !== 'None') ? toWallet : '';
        const feeEl = document.getElementById('updateFee');
        if (feeEl) feeEl.value = (fee != null ? fee : '');

        {
            const el = document.getElementById('updateLoansDate');
            if (el && el._flatpickr) el._flatpickr.setDate(tdate, false, 'Y-m-d\\TH:i');
            else if (el) el.value = tdate || '';
        }
        {
            const el = document.getElementById('updateLoansDueDate');
            if (el && el._flatpickr) el._flatpickr.setDate(dueDate, false, 'Y-m-d\\TH:i');
            else if (el) el.value = dueDate || '';
        }

        document.getElementById('updateLoansNote').value = note || '';
        document.getElementById('deleteForm').action = `/deleteloan/${encodeURIComponent(loanId || '')}`;
        showLoansUpdate();
    }
    window.editLoan = editLoan;

    function editLoanFromRow(buttonEl) {
        const li = buttonEl?.closest('li[data-id]');
        if (!li) return;
        editLoan(
            li.dataset.id,
            li.dataset.userid,
            li.dataset.type,
            li.dataset.status,
            li.dataset.party,
            li.dataset.amount,
            li.dataset.currency,
            li.dataset.from,
            li.dataset.to,
            li.dataset.fee,
            li.dataset.tdate,
            li.dataset.duedate,
            li.dataset.note
        );
    }
    window.editLoanFromRow = editLoanFromRow;

    // Utilities for history filtering/pagination/month grouping (mirrors Crypto)
    function parseLocalDateTime(val) {
        if (!val) return null;
        try { return new Date(val); } catch(e) { return null; }
    }
    function parseTxDate(val) {
        if (!val) return null;
        let s = String(val);
        let d = new Date(s);
        if (isNaN(d)) d = new Date(s.replace(' ', 'T'));
        return isNaN(d) ? null : d;
    }
    function monthKeyFromDate(d) {
        if (!d || isNaN(d)) return 'unknown';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
    }
    function monthLabelFromDate(d) {
        if (!d || isNaN(d)) return 'Unknown date';
        try {
            return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }
    }
    function buildLoansMonthGroups() {
        const list = document.getElementById('loansList');
        if (!list) return;
        list.querySelectorAll('li.crypto-group-header').forEach(h => h.remove());
        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        if (!txItems.length) return;
        let currentKey = null;
        txItems.forEach(li => {
            const d = parseTxDate(li.getAttribute('data-tdate'));
            const key = monthKeyFromDate(d);
            li.setAttribute('data-group', key);
            if (key !== currentKey) {
                const header = document.createElement('li');
                header.className = 'crypto-group-header';
                header.setAttribute('data-group', key);
                header.textContent = monthLabelFromDate(d);
                list.insertBefore(header, li);
                currentKey = key;
            }
        });
    }
    function syncLoansGroupHeaders() {
        const list = document.getElementById('loansList');
        if (!list) return;
        const headers = Array.from(list.querySelectorAll('li.crypto-group-header'));
        if (!headers.length) return;
        const txItems = Array.from(list.querySelectorAll('li[data-tdate]'));
        headers.forEach(h => {
            const key = h.getAttribute('data-group') || '';
            const anyVisible = txItems.some(li => {
                if ((li.getAttribute('data-group') || '') !== key) return false;
                return li.style.display !== 'none';
            });
            h.style.display = anyVisible ? '' : 'none';
        });
    }
    function ensureLoansGroupsBuilt(force) {
        const list = document.getElementById('loansList');
        if (!list) return;
        const hasHeaders = !!list.querySelector('li.crypto-group-header');
        if (force || !hasHeaders) buildLoansMonthGroups();
        syncLoansGroupHeaders();
    }

    function applyLoansFilters() {
        const list = document.getElementById('loansList');
        if (!list) return;
        ensureLoansGroupsBuilt(false);
        const items = Array.from(list.querySelectorAll('li[data-tdate]'));
        const startVal = document.getElementById('filterStart')?.value || '';
        const endVal = document.getElementById('filterEnd')?.value || '';
        const typeVal = (document.getElementById('filterType')?.value || '').trim().toLowerCase();
        const partyVal = (document.getElementById('filterParty')?.value || '').trim().toLowerCase();
        const noteVal = (document.getElementById('filterNote')?.value || '').trim().toLowerCase();
        const fromVal = String(document.getElementById('filterFromWallet')?.value || '').trim();
        const toVal = String(document.getElementById('filterToWallet')?.value || '').trim();
        const startDt = parseLocalDateTime(startVal);
        const endDt = parseLocalDateTime(endVal);

        if (window.loansPageSize == null) window.loansPageSize = 20;
        if (window.loansCurrentPage == null) window.loansCurrentPage = 1;

        function itemMatches(li) {
            let show = true;
            const tdate = parseTxDate(li.getAttribute('data-tdate'));
            if (startDt && tdate && tdate < startDt) show = false;
            if (endDt && tdate && tdate > endDt) show = false;
            if ((startDt || endDt) && !tdate) show = false;

            if (show && typeVal) {
                const t = (li.getAttribute('data-type') || '').toLowerCase();
                if (!t.includes(typeVal)) show = false;
            }
            if (show && partyVal) {
                const p = (li.getAttribute('data-party') || '').toLowerCase();
                if (!p.includes(partyVal)) show = false;
            }
            if (show && noteVal) {
                const n = (li.getAttribute('data-note') || '').toLowerCase();
                if (!n.includes(noteVal)) show = false;
            }
            if (show && fromVal) {
                const f = String(li.getAttribute('data-from') || '').trim();
                if (f !== fromVal) show = false;
            }
            if (show && toVal) {
                const t = String(li.getAttribute('data-to') || '').trim();
                if (t !== toVal) show = false;
            }
            return show;
        }

        const matching = items.filter(itemMatches);
        const total = matching.length;
        const pageSize = Number(window.loansPageSize) || 20;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        window.loansCurrentPage = Math.min(Math.max(1, Number(window.loansCurrentPage) || 1), totalPages);

        items.forEach(li => { li.style.display = 'none'; });
        const startIdx = (window.loansCurrentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        matching.slice(startIdx, endIdx).forEach(li => { li.style.display = ''; });
        syncLoansGroupHeaders();

        const emptyMsg = document.getElementById('filterEmptyMsg');
        if (emptyMsg) emptyMsg.style.display = total ? 'none' : '';

        const pager = document.getElementById('loansPagination');
        const pageInfo = document.getElementById('loansPageInfo');
        const prevBtn = document.getElementById('loansPrevPage');
        const nextBtn = document.getElementById('loansNextPage');
        if (pager) pager.style.display = total ? '' : 'none';
        if (pageInfo) pageInfo.textContent = `Page ${window.loansCurrentPage} of ${totalPages}`;
        if (prevBtn) prevBtn.disabled = window.loansCurrentPage <= 1;
        if (nextBtn) nextBtn.disabled = window.loansCurrentPage >= totalPages;
    }
    window.applyLoansFilters = applyLoansFilters;

    function resetLoansFilters() {
        ['filterStart','filterEnd','filterType','filterParty','filterNote','filterFromWallet','filterToWallet'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el._flatpickr) {
                el._flatpickr.clear();
                return;
            }
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        });
        window.loansCurrentPage = 1;
        applyLoansFilters();
    }
    window.resetLoansFilters = resetLoansFilters;

    function loansGoToPrevPage() {
        window.loansCurrentPage = Math.max(1, (Number(window.loansCurrentPage) || 1) - 1);
        applyLoansFilters();
    }
    function loansGoToNextPage() {
        window.loansCurrentPage = (Number(window.loansCurrentPage) || 1) + 1;
        applyLoansFilters();
    }
    window.loansGoToPrevPage = loansGoToPrevPage;
    window.loansGoToNextPage = loansGoToNextPage;

    document.addEventListener('DOMContentLoaded', function() {
        // Sort newest-first, then build month headers
        const list = document.getElementById('loansList');
        if (list && list.children && list.children.length) {
            const items = Array.from(list.querySelectorAll('li[data-tdate]'));
            if (items.length > 1) {
                items.sort((a, b) => {
                    let dateA = new Date(a.getAttribute('data-tdate') || 0);
                    let dateB = new Date(b.getAttribute('data-tdate') || 0);
                    return dateB - dateA;
                });
                items.forEach(item => list.appendChild(item));
            }
            ensureLoansGroupsBuilt(true);
        }

        const fStart = document.getElementById('filterStart');
        const fEnd = document.getElementById('filterEnd');
        const fType = document.getElementById('filterType');
        const fParty = document.getElementById('filterParty');
        const fNote = document.getElementById('filterNote');
        const fFrom = document.getElementById('filterFromWallet');
        const fTo = document.getElementById('filterToWallet');
        ['input','change'].forEach(evt => {
            if (fStart) fStart.addEventListener(evt, applyLoansFilters);
            if (fEnd) fEnd.addEventListener(evt, applyLoansFilters);
            if (fType) fType.addEventListener(evt, applyLoansFilters);
            if (fParty) fParty.addEventListener(evt, applyLoansFilters);
            if (fNote) fNote.addEventListener(evt, applyLoansFilters);
            if (fFrom) fFrom.addEventListener(evt, applyLoansFilters);
            if (fTo) fTo.addEventListener(evt, applyLoansFilters);
        });

        showLoansPortfolio();
    });
</script>

{% else %}
<script>
    window.location.replace('/login');
</script>
{% endif %}
{% endblock %}
